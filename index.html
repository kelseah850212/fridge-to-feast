<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge To Feast (v4.0 Favorites)</title>
    
    <!-- Google tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQYJNTJQ1D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RQYJNTJQ1D');
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5498579882044646"
         crossorigin="anonymous"></script>

    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJGcmlkZ2UgVG8gRmVhc3QiLA0KICAic2hvcnRfbmFtZSI6ICJGcmlkZ2VGZWFzdCIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjE5MngxOTIiDQogICAgfSwNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiDQogICAgfQ0KICBdLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgInRoZW1lX2NvbG9yIjogIiMxMEI5ODEiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRjlGQUZCIg0KfQ==">
    <meta name="theme-color" content="#10B981">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap');
        body { font-family: 'Poppins', 'Noto Sans TC', sans-serif; }
        .style-btn, .preference-btn, .popular-search-btn, #lang-switcher, #my-favorites-btn { transition: all 0.2s ease-in-out; }
        .style-btn:hover, .popular-search-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .preference-btn.active {
            background-color: #10B981; color: white; border-color: #10B981;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        #favorite-btn {
            position: absolute; top: 1rem; right: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 9999px; width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; color: #fbbf24; /* amber-400 */
            transition: all 0.2s ease-in-out;
        }
        #favorite-btn:hover { transform: scale(1.1); }
        #favorite-btn.saved .fa-star { font-weight: 900; } /* solid star */
    </style>

</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl p-4 relative pb-24">
        <div class="flex justify-end items-center gap-2 mb-4">
            <button id="my-favorites-btn" class="text-sm font-semibold text-gray-600 hover:text-green-500 py-2 px-3 bg-white rounded-lg shadow-sm border"><i class="fas fa-star mr-1 text-amber-400"></i><span data-translate="my_favorites">æˆ‘çš„æœ€æ„›</span></button>
            <button id="lang-switcher" class="text-sm font-semibold text-gray-600 hover:text-green-500 py-2 px-3 bg-white rounded-lg shadow-sm border">English</button>
        </div>
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-gray-800" data-translate="main_title">Fridge To Feast</h1>
            <p class="text-gray-500 mt-2" data-translate="subtitle">è¼¸å…¥é£Ÿææ‰¾éˆæ„Ÿï¼Œæˆ–ç›´æ¥æœå°‹èœåï¼</p>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-green-500 transition-colors">
                <i class="fas fa-utensils text-gray-400 mx-3"></i>
                <input type="text" id="main-input" class="w-full p-3 outline-none">
                <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-r-lg transition-colors">
                    <i class="fas fa-search mr-2"></i><span data-translate="start_button">é–‹å§‹</span>
                </button>
            </div>
            <div id="preferences-container" class="mt-4 flex flex-wrap justify-center gap-3">
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="vegetarian" data-translate="pref_vegetarian">ç´ é£Ÿ</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="low-calorie" data-translate="pref_low_calorie">ä½ç†±é‡</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="spicy" data-translate="pref_spicy">è¦è¾£</button>
            </div>
        </div>
        
        <div id="initial-content-container" class="mt-8">
             <!-- Initial content is now dynamically managed by JS -->
        </div>

        <div id="result-container" class="mt-8 grid gap-8"></div>
    </div>

    <!-- Templates -->
    <template id="initial-content-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="welcome_title">æ­¡è¿ä¾†åˆ° Fridge To Feastï¼</h2>
            <p class="text-gray-600 mb-6" data-translate="welcome_text">å†ä¹Ÿä¸ç”¨ç…©æƒ±å†°ç®±è£¡çš„é£Ÿæèƒ½åšä»€éº¼èœã€‚æˆ‘å€‘åˆ©ç”¨ AI ç‚ºæ‚¨å‰µé€ ç¾å‘³é£Ÿè­œï¼Œå°‡å‰©é¤˜é£Ÿæè®Šæˆé¤æ¡Œä¸Šçš„ç››å®´ï¼</p>
            <h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="how_to_use_title">å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h3>
            <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
                <li data-translate="step1_text">åœ¨ä¸Šé¢çš„æœå°‹æ¡†ä¸­ï¼Œè¼¸å…¥æ‚¨æ“æœ‰çš„é£Ÿæï¼ˆä¾‹å¦‚ï¼šé›è›‹, ç•ªèŒ„, æ´‹è”¥ï¼‰ã€‚</li>
                <li data-translate="step2_text">é¸æ“‡æ‚¨çš„é£²é£Ÿåå¥½ï¼ˆä¾‹å¦‚ï¼šç´ é£Ÿã€è¦è¾£ï¼‰ã€‚</li>
                <li data-translate="step3_text">é»æ“Šã€Œé–‹å§‹ã€ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è®Šå‡ºé­”æ³•ï¼</li>
            </ol>
            <h3 class="text-xl font-semibold text-gray-700 mb-4" data-translate="popular_searches_title">ç†±é–€æœå°‹</h3>
            <div id="popular-searches-container" class="flex flex-wrap gap-3">
                <button class="popular-search-btn bg-green-100 text-green-700 py-2 px-4 rounded-full font-semibold" data-search="é›è›‹">ğŸ³ é›è›‹</button>
                <button class="popular-search-btn bg-blue-100 text-blue-700 py-2 px-4 rounded-full font-semibold" data-search="é›è‚‰">ğŸ— é›è‚‰</button>
                <button class="popular-search-btn bg-red-100 text-red-700 py-2 px-4 rounded-full font-semibold" data-search="ç•ªèŒ„">ğŸ… ç•ªèŒ„</button>
                <button class="popular-search-btn bg-yellow-100 text-yellow-700 py-2 px-4 rounded-full font-semibold" data-search="é¦¬éˆ´è–¯">ğŸ¥” é¦¬éˆ´è–¯</button>
                <button class="popular-search-btn bg-teal-100 text-teal-700 py-2 px-4 rounded-full font-semibold" data-search="æ“‚èŒ¶">ğŸµ æ“‚èŒ¶</button>
            </div>
        </div>
    </template>
    <template id="favorites-view-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="favorites_title">æˆ‘çš„æœ€æ„›é£Ÿè­œ</h2>
            <p id="no-favorites-text" class="text-gray-500" data-translate="no_favorites_text">æ‚¨é‚„æ²’æœ‰æ”¶è—ä»»ä½•é£Ÿè­œã€‚çœ‹åˆ°å–œæ­¡çš„é£Ÿè­œæ™‚ï¼Œé»æ“Šå³ä¸Šè§’çš„æ˜Ÿè™Ÿå°±å¯ä»¥æ”¶è—èµ·ä¾†ï¼</p>
        </div>
    </template>
    <template id="recipe-card-template">
        <div class="bg-white p-6 rounded-xl shadow-lg relative">
            <button id="favorite-btn" title="åŠ å…¥æˆ‘çš„æœ€æ„›"><i class="far fa-star"></i></button>
            <div class="relative"><img id="recipe-image" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-4 shadow-md"><div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded" data-translate="image_ref_note">å›¾ç‰‡åªä¾›å‚è€ƒ</div></div>
            <div id="favorite-reminder" class="text-sm text-center text-gray-500 mb-4 italic" data-translate="favorite_reminder">å–œæ­¡é€™é“èœï¼Ÿé»æ“Šæ˜Ÿè™Ÿæ”¶è—ï¼Œéš¨æ™‚é›¢ç·šæŸ¥çœ‹ï¼</div>
            <h2 id="recipe-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p class="text-gray-600 mb-4"><i class="fas fa-fire-alt mr-2 text-red-500"></i><span data-translate="calories_label">é ä¼°å¡è·¯é‡Œ</span>: <span id="recipe-calories"></span> <span class="text-xs text-gray-400" data-translate="calories_note">(ä¼°ç®—å€¼)</span></p>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="ingredients_label">æ‰€éœ€é£Ÿæ</h3><ul id="recipe-ingredients" class="list-disc list-inside space-y-2 text-gray-600"></ul></div>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="instructions_label">åšæ³•</h3><div id="recipe-instructions" class="space-y-3 text-gray-600 leading-relaxed"></div></div>
        </div>
    </template>
    <template id="error-message-template">
         <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
            <p class="font-bold" data-translate="error_title_busy">AI å»šå¸«æ­£åœ¨å¿™ç¢Œä¸­ï¼</p>
            <p id="error-text"></p>
         </div>
    </template>

    <script>
        // --- STABILITY: Global Error Handler ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("A global error was caught:", message, error);
            try {
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    const lang = localStorage.getItem('fridgeToFeastLang') || 'zh';
                    const errorTitle = lang === 'zh' ? 'å™¢ä¸ï¼Œç™¼ç”Ÿäº†æœªçŸ¥çš„éŒ¯èª¤ï¼' : 'An unexpected error occurred!';
                    const errorMessage = lang === 'zh' ? 'è«‹ç¨å¾Œå†è©¦æˆ–é‡æ–°æ•´ç†é é¢ã€‚' : 'Please try again later or refresh the page.';
                    resultContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">${errorTitle}</p><p>${errorMessage}</p></div>`;
                }
            } catch (e) {
                console.error("Could not display global error message:", e);
            }
            return true;
        };
        
        // --- I18N ---
        const translations = {
            zh: { lang_switcher: "English", main_title: "Fridge To Feast", subtitle: "è¼¸å…¥é£Ÿææ‰¾éˆæ„Ÿï¼Œæˆ–ç›´æ¥æœå°‹èœåï¼", input_placeholder: "ä¾‹å¦‚: é›è›‹, ç•ªèŒ„", start_button: "é–‹å§‹", thinking: "æ€è€ƒä¸­...", generating_recipe: "ç”Ÿæˆé£Ÿè­œä¸­...", generating_image: "ç¹ªè£½åœ–ç‰‡ä¸­...", art_director: "è˜è«‹é€ å‹å¸«...", how_to_cook: "ä½ æƒ³æ€éº¼ç…®ï¼Ÿ", ai_creative_style: "AIå‰µæ„ç…®æ³•", image_ref_note: "å›¾ç‰‡åªä¾›å‚è€ƒ", calories_label: "é ä¼°å¡è·¯é‡Œ", calories_note: "(ä¼°ç®—å€¼)", ingredients_label: "æ‰€éœ€é£Ÿæ", instructions_label: "åšæ³•", error_title: "å™¢ä¸ï¼Œå‡ºéŒ¯äº†ï¼", error_title_busy: "AI å»šå¸«æ­£åœ¨å¿™ç¢Œä¸­ï¼", error_busy_text: "ä¼ºæœå™¨ç›®å‰ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚å»ºè­°å°‡å–œæ­¡çš„é£Ÿè­œæ”¶è—èµ·ä¾†ï¼", error_input_required: "è«‹è¼¸å…¥é£Ÿææˆ–èœåï¼", error_generic: "ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", error_recipe_gen: "ç”Ÿæˆé£Ÿè­œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", step_label: "æ­¥é©Ÿ", pref_vegetarian: "ç´ é£Ÿ", pref_low_calorie: "ä½ç†±é‡", pref_spicy: "è¦è¾£", welcome_title: "æ­¡è¿ä¾†åˆ° Fridge To Feastï¼", welcome_text: "å†ä¹Ÿä¸ç”¨ç…©æƒ±å†°ç®±è£¡çš„é£Ÿæèƒ½åšä»€éº¼èœã€‚æˆ‘å€‘åˆ©ç”¨ AI ç‚ºæ‚¨å‰µé€ ç¾å‘³é£Ÿè­œï¼Œå°‡å‰©é¤˜é£Ÿæè®Šæˆé¤æ¡Œä¸Šçš„ç››å®´ï¼", how_to_use_title: "å¦‚ä½•ä½¿ç”¨ï¼Ÿ", step1_text: "åœ¨ä¸Šé¢çš„æœå°‹æ¡†ä¸­ï¼Œè¼¸å…¥æ‚¨æ“æœ‰çš„é£Ÿæï¼ˆä¾‹å¦‚ï¼šé›è›‹, ç•ªèŒ„, æ´‹è”¥ï¼‰ã€‚", step2_text: "é¸æ“‡æ‚¨çš„é£²é£Ÿåå¥½ï¼ˆä¾‹å¦‚ï¼šç´ é£Ÿã€è¦è¾£ï¼‰ã€‚", step3_text: "é»æ“Šã€Œé–‹å§‹ã€ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è®Šå‡ºé­”æ³•ï¼", popular_searches_title: "ç†±é–€æœå°‹", my_favorites: "æˆ‘çš„æœ€æ„›", favorites_title: "æˆ‘çš„æœ€æ„›é£Ÿè­œ", no_favorites_text: "æ‚¨é‚„æ²’æœ‰æ”¶è—ä»»ä½•é£Ÿè­œã€‚çœ‹åˆ°å–œæ­¡çš„é£Ÿè­œæ™‚ï¼Œé»æ“Šå³ä¸Šè§’çš„æ˜Ÿè™Ÿå°±å¯ä»¥æ”¶è—èµ·ä¾†ï¼", favorite_reminder: "å–œæ­¡é€™é“èœï¼Ÿé»æ“Šæ˜Ÿè™Ÿæ”¶è—ï¼Œéš¨æ™‚é›¢ç·šæŸ¥çœ‹ï¼" },
            en: { lang_switcher: "ä¸­æ–‡", main_title: "Fridge To Feast", subtitle: "Enter ingredients for ideas, or search for a recipe directly!", input_placeholder: "e.g., egg, tomato", start_button: "Start", thinking: "Thinking...", generating_recipe: "Generating Recipe...", generating_image: "Creating Image...", art_director: "Hiring Art Director...", how_to_cook: "How would you like to cook it?", ai_creative_style: "AI Creative Style", image_ref_note: "Image for reference only", calories_label: "Est. Calories", calories_note: "(approx.)", ingredients_label: "Ingredients", instructions_label: "Instructions", error_title: "Oh no, an error occurred!", error_title_busy: "AI Chef is Busy!", error_busy_text: "The server is currently unavailable. Please try again later. Consider saving recipes you like to your favorites!", error_input_required: "Please enter ingredients or a recipe name!", error_generic: "Could not process your request. Please try again later.", error_recipe_gen: "Failed to generate recipe. Please try again later.", step_label: "Step", pref_vegetarian: "Vegetarian", pref_low_calorie: "Low-Calorie", pref_spicy: "Spicy", welcome_title: "Welcome to Fridge To Feast!", welcome_text: "Stop wondering what to cook with the ingredients in your fridge. We use AI to create delicious recipes, turning your leftovers into a feast!", how_to_use_title: "How to Use?", step1_text: "Enter the ingredients you have in the search bar above (e.g., egg, tomato, onion).", step2_text: "Select your dietary preferences (e.g., Vegetarian, Spicy).", step3_text: "Click 'Start' and let us work our magic!", popular_searches_title: "Popular Searches", my_favorites: "My Favorites", favorites_title: "My Favorite Recipes", no_favorites_text: "You haven't saved any recipes yet. When you find a recipe you like, click the star icon to save it!", favorite_reminder: "Like this recipe? Tap the star to save it for offline access!" }
        };
        let currentLanguage = localStorage.getItem('fridgeToFeastLang') || 'zh';
        
        // --- Expert Knowledge Base ---
        const expertRecipes = {
            'æ“‚èŒ¶': {
                zh: { recipeName: "æ­£å®—å®¢å®¶æ“‚èŒ¶", calories: 450, ingredients: [ { name: "ç¶ èŒ¶è‘‰", quantity: "1æ¹¯åŒ™" }, { name: "çƒ¤èŠ±ç”Ÿ", quantity: "50å…‹" }, { name: "çƒ¤èŠéº»", quantity: "2æ¹¯åŒ™" }, { name: "è–„è·è‘‰", quantity: "1å°æŠŠ" }, { name: "ä¹å±¤å¡” (é‡‘ä¸æ›)", quantity: "1å°æŠŠ" }, { name: "é•·è±†", quantity: "100å…‹ (åˆ‡ç²’)" }, { name: "èœè„¯ (ç”œ)", quantity: "3æ¹¯åŒ™ (åˆ‡ç¢)" }, { name: "è±†è…ä¹¾", quantity: "2å¡Š (åˆ‡ä¸)" }, { name: "è¦ç±³", quantity: "1æ¹¯åŒ™ (å¯é¸)" }, { name: "æ¨¹ä»”èœ", quantity: "1æŠŠ" }, { name: "ç™½é£¯", quantity: "2ç¢—" } ], instructions: [ "æ“‚èŒ¶é†¬ï¼šå°‡ç¶ èŒ¶è‘‰ã€çƒ¤èŠ±ç”Ÿã€çƒ¤èŠéº»ã€è–„è·è‘‰å’Œä¹å±¤å¡”æ”¾å…¥æ“‚ç¼½ä¸­ï¼Œç”¨æ“‚æ£æ…¢æ…¢ç ”ç£¨æˆå¹¼æ»‘çš„ç³Šç‹€ã€‚", "æº–å‚™é…æ–™ï¼šåˆ†åˆ¥å°‡é•·è±†ã€è±†è…ä¹¾ç‚’ç†Ÿã€‚èœè„¯å’Œè¦ç±³ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ä¹Ÿç¨å¾®çˆ†é¦™å‚™ç”¨ã€‚", "æ²–æ³¡èŒ¶æ¹¯ï¼šå°‡ç ”ç£¨å¥½çš„æ“‚èŒ¶é†¬å–å‡ºï¼ŒåŠ å…¥æ»¾æ°´æ”ªæ‹Œå‡å‹»ï¼Œä¾å€‹äººå–œå¥½ç”¨é¹½èª¿å‘³ã€‚", "çµ„åˆï¼šåœ¨ç¢—ä¸­ç››å…¥ç™½é£¯ï¼Œé‹ªä¸Šæ‰€æœ‰æº–å‚™å¥½çš„é…æ–™ã€‚", "äº«ç”¨ï¼šå°‡æº«ç†±çš„æ“‚èŒ¶æ¹¯æ·‹åœ¨é£¯ä¸Šï¼Œæ”ªæ‹Œå‡å‹»å³å¯äº«ç”¨ã€‚" ] },
                en: { recipeName: "Authentic Hakka Lei Cha", calories: 450, ingredients: [ { name: "Green Tea Leaves", quantity: "1 tbsp" }, { name: "Roasted Peanuts", quantity: "50g" }, { name: "Toasted Sesame Seeds", quantity: "2 tbsp" }, { name: "Mint Leaves", quantity: "1 small handful" }, { name: "Basil Leaves", quantity: "1 small handful" }, { name: "Long Beans", quantity: "100g (diced)" }, { name: "Preserved Radish (sweet)", quantity: "3 tbsp (minced)" }, { name: "Firm Tofu", quantity: "2 blocks (diced)" }, { name: "Dried Shrimp", quantity: "1 tbsp (optional)" }, { name: "Mani Cai", quantity: "1 bunch" }, { name: "Cooked Rice", quantity: "2 bowls" } ], instructions: [ "Make the tea paste: In a traditional grooved bowl, grind the green tea leaves, roasted peanuts, sesame seeds, mint, and basil into a smooth paste.", "Prepare toppings: SautÃ© the long beans and diced tofu separately. Briefly stir-fry the preserved radish and dried shrimp (if using).", "Make the tea soup: Take the ground tea paste and whisk it with hot water until well combined. Season with salt to your liking.", "Assemble: Place cooked rice in a bowl and arrange all the prepared toppings over it.", "Serve: Pour the warm tea soup over the rice and toppings. Mix well and enjoy." ] }
            }
        };

        // --- DOM ELEMENTS ---
        const mainInput = document.getElementById('main-input');
        const startBtn = document.getElementById('start-btn');
        const resultContainer = document.getElementById('result-container');
        const langSwitcherBtn = document.getElementById('lang-switcher');
        const myFavoritesBtn = document.getElementById('my-favorites-btn');
        const preferencesContainer = document.getElementById('preferences-container');
        const initialContentContainer = document.getElementById('initial-content-container');
        const templates = { initialContent: document.getElementById('initial-content-template'), favoritesView: document.getElementById('favorites-view-template'), styleSelection: document.getElementById('style-selection-template'), recipeCard: document.getElementById('recipe-card-template'), error: document.getElementById('error-message-template'), };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            showInitialContent();
            
            startBtn.addEventListener('click', () => handleInitialInput(mainInput.value));
            mainInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleInitialInput(mainInput.value); });
            langSwitcherBtn.addEventListener('click', () => { const newLang = currentLanguage === 'zh' ? 'en' : 'zh'; setLanguage(newLang); });
            myFavoritesBtn.addEventListener('click', showFavorites);
            
            preferencesContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('preference-btn')) {
                    event.target.classList.toggle('active');
                }
            });
        });
        
        // --- FAVORITES FUNCTIONS ---
        function getFavorites() {
            return JSON.parse(localStorage.getItem('fridgeToFeastFavorites') || '[]');
        }

        function saveFavorites(favorites) {
            localStorage.setItem('fridgeToFeastFavorites', JSON.stringify(favorites));
        }

        function isFavorite(recipeName) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.recipeName === recipeName);
        }

        function toggleFavorite(recipeData, imageUrl) {
            let favorites = getFavorites();
            const recipeName = recipeData.recipeName;
            const existingIndex = favorites.findIndex(fav => fav.recipeName === recipeName);

            if (existingIndex > -1) { // Already a favorite, so remove it
                favorites.splice(existingIndex, 1);
            } else { // Not a favorite, so add it
                favorites.push({ ...recipeData, imageUrl });
            }
            saveFavorites(favorites);
            return existingIndex === -1; // Return true if it was added, false if removed
        }

        function showFavorites() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = '';
            
            const favorites = getFavorites();
            const favoritesView = templates.favoritesView.content.cloneNode(true);
            resultContainer.appendChild(favoritesView);
            
            const noFavsText = resultContainer.querySelector('#no-favorites-text');

            if (favorites.length === 0) {
                noFavsText.style.display = 'block';
            } else {
                noFavsText.style.display = 'none';
                favorites.forEach(fav => {
                    displayRecipe(fav, fav.imageUrl, true); // Pass a flag to indicate it's a favorite view
                });
            }
            setLanguage(currentLanguage); // Re-apply translations
        }


        // --- LANGUAGE FUNCTIONS ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('fridgeToFeastLang', lang);
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang][key]) { el.textContent = translations[lang][key]; }
            });
            langSwitcherBtn.textContent = translations[lang].lang_switcher;
            mainInput.placeholder = translations[lang].input_placeholder;
        }

        // --- HELPER FUNCTIONS ---
        function getSelectedPreferences() {
            const activeButtons = preferencesContainer.querySelectorAll('.preference-btn.active');
            return Array.from(activeButtons).map(btn => btn.dataset.preference);
        }

        // --- MAIN LOGIC ---
        async function handleInitialInput(userInput) {
            const trimmedInput = userInput.trim();
            if (!trimmedInput) {
                displayError(translations[currentLanguage].error_input_required);
                return;
            }

            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = ''; 
            setLoading(true, translations[currentLanguage].thinking);

            try {
                const expertRecipeKey = Object.keys(expertRecipes).find(key => trimmedInput.includes(key));
                if (expertRecipeKey) {
                    const recipeData = expertRecipes[expertRecipeKey][currentLanguage];
                    await generateFinalRecipe(null, recipeData.recipeName, [], recipeData);
                    return;
                }

                const preferences = getSelectedPreferences();
                const inputType = await determineInputType(trimmedInput);

                if (inputType === 'recipe_name') {
                    await generateFinalRecipe(trimmedInput, trimmedInput, preferences);
                } else {
                    const styles = await getCookingStyles(trimmedInput, preferences);
                    displayCookingStyles(styles, trimmedInput, preferences);
                }
            } catch (error) {
                console.error("Critical Error in Main Flow:", error);
                const isServerError = error.message && error.message.includes('503');
                const errorMessage = isServerError ? translations[currentLanguage].error_busy_text : (error.message || translations[currentLanguage].error_generic);
                displayError(errorMessage, isServerError);
                setLoading(false);
            }
        }

        async function generateFinalRecipe(style, ingredients, preferences, preloadedRecipe = null) {
            try {
                let recipeData;
                if (preloadedRecipe) {
                    recipeData = preloadedRecipe;
                } else {
                    setLoading(true, translations[currentLanguage].generating_recipe);
                    recipeData = await generateRecipe(style, ingredients, preferences);
                    if (!recipeData) throw new Error(translations[currentLanguage].error_recipe_gen);
                }
                
                setLoading(true, translations[currentLanguage].art_director);
                const imagePromptIngredients = preloadedRecipe ? recipeData.recipeName : ingredients;
                const imageUrl = await generateImageWithArtDirector(recipeData, imagePromptIngredients);
                
                // Clear container before displaying the single recipe
                resultContainer.innerHTML = '';
                displayRecipe(recipeData, imageUrl, false);

            } catch (error) {
                console.error("Error in generateFinalRecipe:", error);
                const isServerError = error.message && error.message.includes('503');
                const errorMessage = isServerError ? translations[currentLanguage].error_busy_text : (error.message || translations[currentLanguage].error_generic);
                displayError(errorMessage, isServerError);
            } finally {
                setLoading(false);
            }
        }

        // --- UI DISPLAY ---
        function showInitialContent() {
            resultContainer.innerHTML = ''; // Clear results
            const content = templates.initialContent.content.cloneNode(true);
            initialContentContainer.innerHTML = ''; // Clear previous initial content
            initialContentContainer.appendChild(content);
            initialContentContainer.style.display = 'block';

            // Re-attach listener for popular searches
            const popSearchContainer = initialContentContainer.querySelector('#popular-searches-container');
            if(popSearchContainer) {
                popSearchContainer.addEventListener('click', (event) => {
                    if (event.target.matches('.popular-search-btn')) {
                        const searchTerm = event.target.getAttribute('data-search');
                        mainInput.value = searchTerm;
                        handleInitialInput(searchTerm);
                    }
                });
            }
            setLanguage(currentLanguage);
        }

        function setLoading(isLoading, message) { 
            startBtn.disabled = isLoading; 
            const span = startBtn.querySelector('span');
            if(span) {
                span.textContent = isLoading ? message : translations[currentLanguage].start_button;
            }
            if (isLoading && message === translations[currentLanguage].thinking) { 
                resultContainer.innerHTML = ''; 
            } 
        }

        function displayError(message, isBusy = false) { 
            resultContainer.innerHTML = ''; 
            const errorCard = templates.error.content.cloneNode(true); 
            if (isBusy) {
                errorCard.querySelector('.font-bold').textContent = translations[currentLanguage].error_title_busy;
            } else {
                 errorCard.querySelector('.font-bold').textContent = translations[currentLanguage].error_title;
            }
            errorCard.getElementById('error-text').textContent = message; 
            resultContainer.appendChild(errorCard); 
        }

        function displayCookingStyles(styles, ingredients, preferences) {
            resultContainer.innerHTML = ''; 
            const styleCard = templates.styleSelection.content.cloneNode(true); 
            const container = styleCard.getElementById('style-buttons-container'); 
            styleCard.querySelector('[data-translate="how_to_cook"]').textContent = translations[currentLanguage].how_to_cook; 
            styles.forEach(style => { 
                const button = document.createElement('button'); 
                button.textContent = style; 
                button.className = 'style-btn w-full bg-white p-4 rounded-lg shadow border-2 border-gray-200 hover:border-green-500 hover:text-green-600 font-semibold'; 
                if (style === translations['zh'].ai_creative_style || style === translations['en'].ai_creative_style) { 
                    button.classList.add('bg-green-100', 'text-green-700'); 
                } 
                button.onclick = () => { 
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><div class="bg-gray-200 h-64 w-full rounded-lg animate-pulse"></div><div class="h-8 bg-gray-200 rounded w-3/4 mt-6 animate-pulse"></div></div>`; 
                    generateFinalRecipe(style, ingredients, preferences);
                }; 
                container.appendChild(button); 
            }); 
            resultContainer.appendChild(styleCard); 
            setLoading(false); 
        }

        function displayRecipe(data, imageUrl, isFavoriteView = false) { 
            const cardFragment = templates.recipeCard.content.cloneNode(true);
            const card = cardFragment.firstElementChild;
            
            // --- Translate and Populate ---
            const elementsToTranslate = card.querySelectorAll('[data-translate]'); 
            elementsToTranslate.forEach(el => { 
                const key = el.getAttribute('data-translate'); 
                if (translations[currentLanguage][key]) { el.textContent = translations[currentLanguage][key]; } 
            }); 
            card.querySelector('#recipe-image').src = imageUrl;
            card.querySelector('#recipe-image').alt = `Image of ${data.recipeName}`; 
            card.querySelector('#recipe-name').textContent = data.recipeName; 
            card.querySelector('#recipe-calories').textContent = data.calories; 
            const ingredientsList = card.querySelector('#recipe-ingredients'); 
            ingredientsList.innerHTML = ''; 
            data.ingredients.forEach(item => { const li = document.createElement('li'); li.textContent = `${item.name} - ${item.quantity}`; ingredientsList.appendChild(li); }); 
            const instructionsDiv = card.querySelector('#recipe-instructions'); 
            instructionsDiv.innerHTML = ''; 
            data.instructions.forEach((step, index) => { const p = document.createElement('p'); p.innerHTML = `<strong class="text-green-600">${translations[currentLanguage].step_label} ${index + 1}:</strong> ${step}`; instructionsDiv.appendChild(p); }); 

            // --- Favorite Button Logic ---
            const favBtn = card.querySelector('#favorite-btn');
            const favReminder = card.querySelector('#favorite-reminder');

            function updateFavButtonState() {
                if (isFavorite(data.recipeName)) {
                    favBtn.classList.add('saved');
                    favBtn.title = "å¾æˆ‘çš„æœ€æ„›ä¸­ç§»é™¤";
                } else {
                    favBtn.classList.remove('saved');
                    favBtn.title = "åŠ å…¥æˆ‘çš„æœ€æ„›";
                }
            }
            
            updateFavButtonState();

            favBtn.onclick = () => {
                const added = toggleFavorite(data, imageUrl);
                updateFavButtonState();
                // If in favorites view and item is removed, remove the card from the DOM
                if (isFavoriteView && !added) {
                    card.style.transition = 'opacity 0.3s ease';
                    card.style.opacity = '0';
                    setTimeout(() => { 
                        card.remove();
                        // Check if no favorites are left
                        if (getFavorites().length === 0) {
                            const noFavsText = document.querySelector('#no-favorites-text');
                            if(noFavsText) noFavsText.style.display = 'block';
                        }
                    }, 300);
                }
            };

            // Hide reminder if it's from the favorites view
            if (isFavoriteView) {
                favReminder.style.display = 'none';
            }

            resultContainer.appendChild(card); 
        }
        
        // --- API HELPERS (REAL, PRODUCTION VERSION) ---
        async function makeApiCallWithRetry(targetApi, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            targetApi: targetApi,
                            payload: payload
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API_ERROR_${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    console.error(`API call attempt ${attempt} failed. Retrying...`, error);
                    if (attempt >= maxRetries) {
                        console.error("API call failed after max retries.");
                        throw error;
                    };
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }
        
        async function determineInputType(userInput) { 
            const prompt = `Analyze the following text and determine if it's a 'list of ingredients' or a 'recipe name'. Text: "${userInput}". Respond with only "ingredients" or "recipe_name".`; 
            const payload = { contents: [{ parts: [{ text: prompt }] }] }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().replace(/"/g, ''); 
            if (text === 'ingredients' || text === 'recipe_name') return text; 
            return userInput.includes(',') || userInput.split(' ').length > 2 ? 'ingredients' : 'recipe_name'; 
        }
        
        async function getCookingStyles(ingredients, preferences) { 
            const langInstruction = currentLanguage === 'en' ? 'English' : 'Chinese';
            const preferenceText = preferences.length > 0 ? ` considering these preferences: ${preferences.join(', ')}` : '';
            const prompt = `In JSON array format, list the 4 most popular classic dish names for '${ingredients}' in the Malaysia/Singapore region${preferenceText}. Respond in ${langInstruction}. Example: ["Style A", "Style B"]`; 
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text; 
            let styles = []; 
            try { 
                styles = JSON.parse(text); 
                if (!Array.isArray(styles)) styles = []; 
            } catch { 
                styles = []; 
            } 
            styles.push(translations[currentLanguage].ai_creative_style); 
            return styles; 
        }

        async function generateRecipe(style, ingredients, preferences) { 
            const langInstruction = currentLanguage === 'en' ? 'Respond in English.' : 'è«‹ç”¨ä¸­æ–‡å›ç­”ã€‚';
            const preferenceText = preferences.length > 0 ? `\n3. CRITICAL: The recipe MUST strictly adhere to the following dietary preferences: ${preferences.join(', ')}.` : '';
            const baseRule = `\n\n**Rules:**\n1. Steps must be logical for a home cook.\n2. Quantities must be reasonable.${preferenceText}\nPlease respond STRICTLY in the following JSON format:\n- recipeName (string), description (string), calories (number), ingredients (array of {name, quantity}), instructions (array of strings).\n${langInstruction}`; 
            
            let prompt;
            if (style === translations[currentLanguage].ai_creative_style) { 
                prompt = `You are an experienced home cook. Design a delicious, logical recipe based on these ingredients: ${ingredients}. Create a suitable name for it.` + baseRule; 
            } else { 
                prompt = `You are a professional chef. Provide a detailed, authentic recipe for '${style}'. Main ingredients are '${ingredients}'. The recipe name must be '${style}'.` + baseRule; 
            } 
            
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }], 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            recipeName: { type: "STRING" }, 
                            description: { type: "STRING" }, 
                            calories: { type: "NUMBER" }, 
                            ingredients: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, quantity: { type: "STRING" } }, required: ["name", "quantity"] } }, 
                            instructions: { type: "ARRAY", items: { type: "STRING" } } 
                        }, 
                        required: ["recipeName", "description", "calories", "ingredients", "instructions"] 
                    } 
                } 
            }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text; 
            if (text) { 
                try { return JSON.parse(text); } catch(e) { console.error("Failed to parse recipe JSON:", text, e); throw new Error("AI returned invalid recipe format."); } 
            } 
            return null; 
        }
        
        async function generateImageWithArtDirector(recipeData, originalIngredients) {
            const artDirectorPrompt = await createVisualPrompt(recipeData.recipeName, originalIngredients);
            if (!artDirectorPrompt) {
                console.warn("Art Director failed. Falling back to basic image generation.");
                const fallbackPrompt = `Professional food photography of a dish named '${recipeData.recipeName}' with main ingredients '${originalIngredients}'.`;
                return await generateImage(fallbackPrompt);
            }
            setLoading(true, translations[currentLanguage].generating_image);
            return await generateImage(artDirectorPrompt);
        }

        async function createVisualPrompt(recipeName, ingredients) {
            const prompt = `Act as a professional food stylist. I will give you a dish name. Your task is to write a single, detailed paragraph in English for an AI image generator. This description should be a visually rich "prompt" that describes the dish's appearance, plating, texture, and common garnishes. Be specific about the cultural context (e.g., Japanese, Thai, Chinese).\n\nDish Name: "${recipeName}"\nMain Ingredients: "${ingredients}"\n\nProvide the detailed English visual description now.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const result = await makeApiCallWithRetry('gemini', payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
        }
        
        async function generateImage(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const result = await makeApiCallWithRetry('imagen', payload);

            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
            if (base64Data) {
                return `data:image/png;base64,${base64Data}`;
            }
            return `https://placehold.co/600x400/CCCCCC/FFFFFF?text=Image+Generation+Failed`;
        }

    </script>
</body>
</html>
