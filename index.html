<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge To Feast (v5.1 附PWA提示)</title>
    
    <!-- Google tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RQYJNTJQ1D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RQYJNTJQ1D');
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5498579882044646"
         crossorigin="anonymous"></script>

    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJGcmlkZ2UgVG8gRmVhc3QiLA0KICAic2hvcnRfbmFtZSI6ICJGcmlkZ2VGZWFzdCIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjE5MngxOTIiDQogICAgfSwNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiDQogICAgfQ0KICBdLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgInRoZW1lX2NvbG9yIjogIiMxMEI5ODEiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRjlGQUZCIg0KfQ==">
    <meta name="theme-color" content="#10B981">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap');
        body { font-family: 'Poppins', 'Noto Sans TC', sans-serif; }
        .style-btn, .preference-btn, .popular-search-btn, #lang-switcher, #my-favorites-btn { transition: all 0.2s ease-in-out; }
        .style-btn:hover, .popular-search-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .preference-btn.active {
            background-color: #10B981; color: white; border-color: #10B981;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        .favorite-btn {
            position: absolute; top: 1rem; right: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 9999px; width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; color: #fbbf24;
            transition: all 0.2s ease-in-out;
            z-index: 10; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .favorite-btn:hover { 
            transform: scale(1.1); 
            background-color: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .favorite-btn.saved { 
            background-color: #fbbf24;
            color: white;
        }
        .favorite-btn.saved:hover {
            background-color: #f59e0b;
        }
        
        /* 加载动画 */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 错误提示样式 */
        .error-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-left: 4px solid #f59e0b;
        }
        
        /* 重试按钮样式 */
        .retry-btn {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .retry-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        /* Modal 样式 */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            max-width: 90%; width: 600px; max-height: 80vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        /* PWA 安装提示样式 */
        #install-hint {
            animation: fadeInOut 15s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- PWA 安装提示 -->
    <div id="install-hint" class="hidden fixed top-20 right-4 bg-blue-500 text-white text-xs px-3 py-2 rounded-lg shadow-lg z-50">
        <span data-translate="install_hint_text">點擊右上角圖標，即可將應用程式下載到手機桌面！</span>
        <div class="absolute -top-1 right-4 w-3 h-3 bg-blue-500 transform rotate-45"></div>
    </div>


    <div class="container mx-auto max-w-2xl p-4 relative pb-24">
        <div class="flex justify-end items-center gap-2 mb-4">
            <button id="my-favorites-btn" class="text-sm font-semibold text-gray-600 hover:text-green-500 py-2 px-3 bg-white rounded-lg shadow-sm border">
                <i class="fas fa-star mr-1 text-amber-400"></i>
                <span data-translate="my_favorites">我的最愛</span>
            </button>
            <button id="lang-switcher" class="text-sm font-semibold text-gray-600 hover:text-green-500 py-2 px-3 bg-white rounded-lg shadow-sm border">English</button>
        </div>
        
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-gray-800" data-translate="main_title">Fridge To Feast</h1>
            <p class="text-gray-500 mt-2" data-translate="subtitle">輸入食材找靈感，或直接搜尋菜名！</p>
            
            <div class="mt-6 mb-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-3 rounded-lg shadow-sm">
                    <div class="flex items-center justify-center">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-500 text-sm mr-2"></i>
                            <span class="text-sm text-blue-700 font-medium" data-translate="warm_reminder_title">💡 溫馨提示</span>
                        </div>
                    </div>
                    <div class="mt-2 text-center">
                        <p class="text-xs text-blue-600" data-translate="warm_reminder_text">本站使用真實 AI 進行食譜生成，並非傳統搜索功能。我們致力於為您創造獨特的烹飪靈感，但 AI 服務器偶爾可能會繁忙，請您見諒。建議將喜愛的食譜收藏起來，方便隨時查看！</p>
                    </div>
                    <div class="mt-2 flex justify-center gap-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            <i class="fas fa-robot mr-1 text-xs"></i>真實 AI
                        </span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <i class="fas fa-lightbulb mr-1 text-xs"></i>創意無限
                        </span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                            <i class="fas fa-heart mr-1 text-xs"></i>用心服務
                        </span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-green-500 transition-colors">
                <i class="fas fa-utensils text-gray-400 mx-3"></i>
                <input type="text" id="main-input" class="w-full p-3 outline-none" placeholder="例如: 雞蛋, 番茄">
                <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-r-lg transition-colors">
                    <i class="fas fa-search mr-2"></i><span data-translate="start_button">開始</span>
                </button>
            </div>
            <div id="preferences-container" class="mt-4 flex flex-wrap justify-center gap-3">
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="vegetarian" data-translate="pref_vegetarian">素食</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="low-calorie" data-translate="pref_low_calorie">低熱量</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="spicy" data-translate="pref_spicy">要辣</button>
            </div>
        </div>
        
        <div id="initial-content-container" class="mt-8">
             <!-- Initial content is now dynamically managed by JS -->
        </div>

        <div id="result-container" class="mt-8 grid gap-8"></div>
        
        <footer class="text-center mt-12 py-6 border-t border-gray-200">
            <div class="flex justify-center gap-4 text-sm text-gray-500">
                <a href="#" id="about-link" class="hover:text-green-500" data-translate="footer_about">關於我們</a>
                <a href="#" id="faq-link" class="hover:text-green-500" data-translate="footer_faq">常見問題</a>
                <a href="#" id="terms-link" class="hover:text-green-500" data-translate="footer_terms">服務條款</a>
                <a href="#" id="privacy-link" class="hover:text-green-500" data-translate="footer_privacy">隱私政策</a>
            </div>
            <p class="text-xs text-gray-400 mt-4" data-translate="footer_copyright">© 2025 Fridge To Feast. All Rights Reserved.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="modal-about" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4" data-translate="about_title">關於我們</h2>
            <p class="text-gray-600" data-translate="about_content">Fridge To Feast 誕生於一個簡單的想法：讓烹飪變得更有趣、更輕鬆，並減少食物浪費。我們利用先進的 AI 技術，將您冰箱中零散的食材，轉化為令人驚喜的美味佳餚。無論您是烹飪新手還是經驗豐富的廚師，我們都希望能激發您的烹飪靈感，讓每一餐都成為一場盛宴。</p>
            <button class="modal-close-btn mt-6 bg-green-500 text-white px-4 py-2 rounded-lg" data-translate="close_button">關閉</button>
        </div>
    </div>
    <div id="modal-faq" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4" data-translate="faq_title">常見問題</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold" data-translate="faq_q1_title">Q1: 這個服務是免費的嗎？</h3>
                    <p class="text-gray-600" data-translate="faq_q1_content">是的，我們的核心食譜生成功能完全免費。我們通過網站上的廣告來維持運營，感謝您的支持。</p>
                </div>
                <div>
                    <h3 class="font-semibold" data-translate="faq_q2_title">Q2: AI 生成的食譜可靠嗎？</h3>
                    <p class="text-gray-600" data-translate="faq_q2_content">我們的 AI 經過大量食譜數據的訓練，能提供富有創意且實用的烹飪建議。但 AI 並非完美，我們建議您在烹飪時仍可根據自己的口味和經驗進行微調。</p>
                </div>
                <div>
                    <h3 class="font-semibold" data-translate="faq_q3_title">Q3: 為什麼有時候生成食譜會失敗？</h3>
                    <p class="text-gray-600" data-translate="faq_q3_content">由於 AI 服務器需要巨大的計算資源，在高峰時段（如晚餐時間）可能會出現擁堵或響應緩慢。如果遇到這種情況，請稍後再試，或嘗試使用我們推薦的熱門搜尋。</p>
                </div>
                <div>
                    <h3 class="font-semibold" data-translate="faq_q4_title">Q4: 我可以保存我喜歡的食譜嗎？</h3>
                    <p class="text-gray-600" data-translate="faq_q4_content">當然可以！在每個食譜卡的右上角都有一個星號按鈕，點擊即可將食譜收藏到「我的最愛」，方便您隨時查看，即使在離線狀態下也可以。</p>
                </div>
                 <div>
                    <h3 class="font-semibold" data-translate="faq_q5_title">Q5: 圖片是真實拍攝的嗎？</h3>
                    <p class="text-gray-600" data-translate="faq_q5_content">食譜圖片是由 AI 根據食譜內容生成的，旨在為您提供菜品外觀的靈感，僅供參考。實際成品可能會因食材和烹飪技巧而有所不同。</p>
                </div>
            </div>
            <button class="modal-close-btn mt-6 bg-green-500 text-white px-4 py-2 rounded-lg" data-translate="close_button">關閉</button>
        </div>
    </div>
    <div id="modal-terms" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4" data-translate="terms_title">服務條款</h2>
            <p class="text-sm text-gray-600" data-translate="terms_content">歡迎使用 Fridge To Feast！使用本網站即表示您同意以下條款：本服務提供的所有食譜和建議僅供參考，使用者應自行判斷其適用性與安全性。我們不對因使用本網站內容而導致的任何直接或間接損失負責。我們保留隨時修改或終止服務的權利，恕不另行通知。禁止任何濫用本服務（如惡意爬取數據）的行為。</p>
            <button class="modal-close-btn mt-6 bg-green-500 text-white px-4 py-2 rounded-lg" data-translate="close_button">關閉</button>
        </div>
    </div>
    <div id="modal-privacy" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4" data-translate="privacy_title">隱私政策</h2>
            <p class="text-sm text-gray-600" data-translate="privacy_content">本隱私政策（最後更新於2025年8月16日）旨在說明我們如何收集、使用和保護您的信息。我們尊重您的隱私權，並致力於保護您的個人數據。我們通過 Google Analytics 收集匿名的使用數據（如頁面瀏覽量、設備類型），以改善服務質量，這些數據不包含個人身份信息。我們使用瀏覽器的 LocalStorage 技術來保存您的語言偏好和收藏的食譜，這些信息僅存儲在您的設備上，我們無法訪問。我們使用 Google AdSense 展示廣告，Google 可能會根據您的瀏覽行為使用 Cookie 來投放個性化廣告。您可以通過 Google 的廣告設置來管理您的廣告偏好。我們承諾不會將您的任何數據出售或分享給第三方。若您對本政策有任何疑問，請與我們聯繫。</p>
            <button class="modal-close-btn mt-6 bg-green-500 text-white px-4 py-2 rounded-lg" data-translate="close_button">關閉</button>
        </div>
    </div>

    <!-- Templates -->
    <template id="initial-content-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="welcome_title">歡迎來到 Fridge To Feast！</h2>
            <p class="text-gray-600 mb-6" data-translate="welcome_text">再也不用煩惱冰箱裡的食材能做什麼菜。我們利用 AI 為您創造美味食譜，將剩餘食材變成餐桌上的盛宴！</p>
            
            <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3" data-translate="daily_tips_title">💡 今日烹饪小贴士</h3>
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h4 class="font-medium text-green-600 mb-1" data-translate="tip_storage_title">🥬 食材保存</h4>
                        <p class="text-gray-600" data-translate="tip_storage_content">绿叶蔬菜用湿纸巾包裹后放入保鲜袋，可延长3-5天新鲜度</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h4 class="font-medium text-blue-600 mb-1" data-translate="tip_seasoning_title">🧂 调味技巧</h4>
                        <p class="text-gray-600" data-translate="tip_seasoning_content">炒菜时盐要分两次放：炒制中期少许，起锅前调味</p>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="how_to_use_title">如何使用？</h3>
            <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
                <li data-translate="step1_text">在上面的搜尋框中，輸入您擁有的食材（例如：雞蛋, 番茄, 洋蔥）。</li>
                <li data-translate="step2_text">選擇您的飲食偏好（例如：素食、要辣）。</li>
                <li data-translate="step3_text">點擊「開始」，讓我們為您變出魔法！</li>
            </ol>

            <div class="bg-yellow-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3" data-translate="nutrition_tips_title">🌟 营养搭配小知识</h3>
                <div class="space-y-2 text-sm text-gray-600">
                    <p><strong>蛋白质+维生素C：</strong>牛肉配番茄，促进铁质吸收</p>
                    <p><strong>钙质+维生素D：</strong>豆腐配鱼类，强化骨骼健康</p>
                    <p><strong>膳食纤维：</strong>每餐至少一种绿叶蔬菜，促进消化</p>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-4" data-translate="popular_searches_title">熱門搜尋</h3>
            <div id="popular-searches-container" class="flex flex-wrap gap-3 mb-6">
                <button class="popular-search-btn bg-green-100 text-green-700 py-2 px-4 rounded-full font-semibold" data-search="雞蛋">🍳 雞蛋</button>
                <button class="popular-search-btn bg-blue-100 text-blue-700 py-2 px-4 rounded-full font-semibold" data-search="雞肉">🍗 雞肉</button>
                <button class="popular-search-btn bg-red-100 text-red-700 py-2 px-4 rounded-full font-semibold" data-search="番茄">🍅 番茄</button>
                <button class="popular-search-btn bg-yellow-100 text-yellow-700 py-2 px-4 rounded-full font-semibold" data-search="馬鈴薯">🥔 馬鈴薯</button>
                <button class="popular-search-btn bg-teal-100 text-teal-700 py-2 px-4 rounded-full font-semibold" data-search="擂茶">🍵 擂茶</button>
                <button class="popular-search-btn bg-purple-100 text-purple-700 py-2 px-4 rounded-full font-semibold" data-search="豆腐">🧈 豆腐</button>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-3" data-translate="healthy_eating_title">🍽️ 健康饮食指南</h3>
                <div class="grid md:grid-cols-3 gap-3 text-sm">
                    <div class="text-center p-2 bg-white rounded">
                        <div class="text-2xl mb-1">🥗</div>
                        <div class="font-medium">蔬菜水果</div>
                        <div class="text-gray-600">每日5份</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded">
                        <div class="text-2xl mb-1">🍗</div>
                        <div class="font-medium">优质蛋白</div>
                        <div class="text-gray-600">每餐1份</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded">
                        <div class="text-2xl mb-1">🌾</div>
                        <div class="font-medium">全谷物</div>
                        <div class="text-gray-600">替代精制谷物</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-100 p-4 rounded-xl mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">📚 更多内容</h3>
            <div class="grid md:grid-cols-2 gap-3">
                <a href="#cooking-tips" class="block p-3 bg-white rounded-lg hover:bg-green-50 transition-colors" onclick="showCookingTips()">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">👨‍🍳</span>
                        <div>
                            <div class="font-medium">烹饪技巧大全</div>
                            <div class="text-sm text-gray-600">专业厨师分享的实用技巧</div>
                        </div>
                    </div>
                </a>
                <a href="#nutrition-guide" class="block p-3 bg-white rounded-lg hover:bg-blue-50 transition-colors" onclick="showNutritionGuide()">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">🥑</span>
                        <div>
                            <div class="font-medium">营养搭配指南</div>
                            <div class="text-sm text-gray-600">科学的营养搭配原则</div>
                        </div>
                    </div>
                </a>
                <a href="#ingredient-storage" class="block p-3 bg-white rounded-lg hover:bg-yellow-50 transition-colors" onclick="showStorageGuide()">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">🧊</span>
                        <div>
                            <div class="font-medium">食材保存秘籍</div>
                            <div class="text-sm text-gray-600">延长食材新鲜度的方法</div>
                        </div>
                    </div>
                </a>
                <a href="#seasonal-recipes" class="block p-3 bg-white rounded-lg hover:bg-purple-50 transition-colors" onclick="showSeasonalRecipes()">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">🌸</span>
                        <div>
                            <div class="font-medium">时令食谱推荐</div>
                            <div class="text-sm text-gray-600">根据季节推荐最佳食材</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </template>
    
    <template id="favorites-view-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="favorites_title">我的最愛食譜</h2>
            <p id="no-favorites-text" class="text-gray-500" data-translate="no_favorites_text">您還沒有收藏任何食譜。看到喜歡的食譜時，點擊右上角的星號就可以收藏起來！</p>
        </div>
    </template>
    
    <template id="recipe-card-template">
        <div class="bg-white p-6 rounded-xl shadow-lg relative">
            <button class="favorite-btn" title="加入我的最愛">
                <i class="far fa-star"></i>
            </button>
            <div class="relative">
                <img class="recipe-image w-full h-64 object-cover rounded-lg mb-4 shadow-md" src="" alt="Recipe Image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/FFFFFF?text=Image+Error';">
                <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded" data-translate="image_ref_note">图片只供参考</div>
            </div>
            <div class="favorite-reminder text-sm text-center text-gray-500 mb-4 italic" data-translate="favorite_reminder">喜歡這道菜？點擊星號收藏，隨時離線查看！</div>
            <h2 class="recipe-name text-3xl font-bold text-gray-800 mb-2"></h2>
            <p class="text-gray-600 mb-4">
                <i class="fas fa-fire-alt mr-2 text-red-500"></i>
                <span data-translate="calories_label">預估卡路里</span>: 
                <span class="recipe-calories"></span> 
                <span class="text-xs text-gray-400" data-translate="calories_note">(估算值)</span>
            </p>
            <div class="mt-6">
                <h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="ingredients_label">所需食材</h3>
                <ul class="recipe-ingredients list-disc list-inside space-y-2 text-gray-600"></ul>
            </div>
            <div class="mt-6">
                <h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="instructions_label">做法</h3>
                <div class="recipe-instructions space-y-3 text-gray-600 leading-relaxed"></div>
            </div>
        </div>
    </template>
    
    <template id="error-message-template">
        <div class="error-card p-6 rounded-xl shadow-lg" role="alert">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-3"></i>
                <h3 class="text-xl font-bold text-gray-800 error-title">AI 廚師正在忙碌中！</h3>
            </div>
            <div class="error-content mb-6">
                <p class="text-gray-700 mb-3 error-text"></p>
                <div class="bg-white bg-opacity-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-2"><strong>💡 建議解決方案：</strong></p>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 等待 30-60 秒後重試</li>
                        <li>• 避開使用高峰期（晚餐時間 6-8pm）</li>
                        <li>• 將喜歡的食譜先收藏起來，避免重新生成</li>
                        <li>• 嘗試簡化搜索內容</li>
                    </ul>
                </div>
            </div>
            <div class="flex gap-3">
                <button class="retry-btn text-white px-6 py-3 rounded-lg font-semibold flex items-center">
                    <i class="fas fa-redo mr-2"></i>
                    <span class="retry-text">重試</span>
                </button>
                <button class="back-home-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-home mr-2"></i>
                    返回首頁
                </button>
            </div>
        </div>
    </template>

    <script>
        // --- 全域錯誤處理 ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全域錯誤:", message, error);
            try {
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    const lang = localStorage.getItem('fridgeToFeastLang') || 'zh';
                    const errorTitle = lang === 'zh' ? '噢不，發生了未知的錯誤！' : 'An unexpected error occurred!';
                    const errorMessage = lang === 'zh' ? '請重新整理頁面或稍後再試。' : 'Please refresh the page or try again later.';
                    displayError(errorMessage, false, errorTitle);
                }
            } catch (e) {
                console.error("無法顯示錯誤信息:", e);
            }
            return true;
        };
        
        // --- 翻譯系統 ---
        const translations = {
            zh: { 
                lang_switcher: "English", main_title: "Fridge To Feast", subtitle: "輸入食材找靈感，或直接搜尋菜名！", input_placeholder: "例如: 雞蛋, 番茄", start_button: "開始", thinking: "思考中...", generating_recipe: "生成食譜中...", generating_image: "繪製圖片中...", art_director: "聘請造型師...", how_to_cook: "你想怎麼煮？", ai_creative_style: "AI創意煮法", image_ref_note: "图片只供参考", calories_label: "預估卡路里", calories_note: "(估算值)", ingredients_label: "所需食材", instructions_label: "做法", error_title: "噢不，出錯了！", error_title_busy: "AI 廚師正在忙碌中！", error_busy_text: "伺服器目前忙碌中，請稍後重試。建議先將喜歡的食譜收藏起來！", error_input_required: "請輸入食材或菜名！", error_generic: "無法處理您的請求，請稍後再試。", error_recipe_gen: "生成食譜失敗，請稍後再試。", error_timeout: "請求超時，伺服器響應較慢。", error_network: "網路連接問題，請檢查您的網路連接。", step_label: "步驟", pref_vegetarian: "素食", pref_low_calorie: "低熱量", pref_spicy: "要辣", welcome_title: "歡迎來到 Fridge To Feast！", welcome_text: "再也不用煩惱冰箱裡的食材能做什麼菜。我們利用 AI 為您創造美味食譜，將剩餘食材變成餐桌上的盛宴！", how_to_use_title: "如何使用？", step1_text: "在上面的搜尋框中，輸入您擁有的食材（例如：雞蛋, 番茄, 洋蔥）。", step2_text: "選擇您的飲食偏好（例如：素食、要辣）。", step3_text: "點擊「開始」，讓我們為您變出魔法！", popular_searches_title: "熱門搜尋", my_favorites: "我的最愛", favorites_title: "我的最愛食譜", no_favorites_text: "您還沒有收藏任何食譜。看到喜歡的食譜時，點擊右上角的星號就可以收藏起來！", favorite_reminder: "喜歡這道菜？點擊星號收藏，隨時離線查看！", retry_text: "重試", retrying_text: "重試中...", back_home: "返回首頁", warm_reminder_title: "💡 溫馨提示", warm_reminder_text: "本站使用真實 AI 進行食譜生成，並非傳統搜索功能。我們致力於為您創造獨特的烹飪靈感，但 AI 服務器偶爾可能會繁忙，請您見諒。建議將喜愛的食譜收藏起來，方便隨時查看！", daily_tips_title: "💡 今日烹饪小贴士", nutrition_tips_title: "🌟 营养搭配小知识", healthy_eating_title: "🍽️ 健康饮食指南",
                footer_about: "關於我們", footer_faq: "常見問題", footer_terms: "服務條款", footer_privacy: "隱私政策", footer_copyright: "© 2025 Fridge To Feast. 版權所有。", close_button: "關閉",
                about_title: "關於我們", about_content: "Fridge To Feast 誕生於一個簡單的想法：讓烹飪變得更有趣、更輕鬆，並減少食物浪費。我們利用先進的 AI 技術，將您冰箱中零散的食材，轉化為令人驚喜的美味佳餚。無論您是烹飪新手還是經驗豐富的廚師，我們都希望能激發您的烹飪靈感，讓每一餐都成為一場盛宴。",
                faq_title: "常見問題", faq_q1_title: "Q1: 這個服務是免費的嗎？", faq_q1_content: "是的，我們的核心食譜生成功能完全免費。我們通過網站上的廣告來維持運營，感謝您的支持。", faq_q2_title: "Q2: AI 生成的食譜可靠嗎？", faq_q2_content: "我們的 AI 經過大量食譜數據的訓練，能提供富有創意且實用的烹飪建議。但 AI 並非完美，我們建議您在烹飪時仍可根據自己的口味和經驗進行微調。", faq_q3_title: "Q3: 為什麼有時候生成食譜會失敗？", faq_q3_content: "由於 AI 服務器需要巨大的計算資源，在高峰時段（如晚餐時間）可能會出現擁堵或響應緩慢。如果遇到這種情況，請稍後再試，或嘗試使用我們推薦的熱門搜尋。", faq_q4_title: "Q4: 我可以保存我喜歡的食譜嗎？", faq_q4_content: "當然可以！在每個食譜卡的右上角都有一個星號按鈕，點擊即可將食譜收藏到「我的最愛」，方便您隨時查看，即使在離線狀態下也可以。", faq_q5_title: "Q5: 圖片是真實拍攝的嗎？", faq_q5_content: "食譜圖片是由 AI 根據食譜內容生成的，旨在為您提供菜品外觀的靈感，僅供參考。實際成品可能會因食材和烹飪技巧而有所不同。",
                terms_title: "服務條款", terms_content: "歡迎使用 Fridge To Feast！使用本網站即表示您同意以下條款：本服務提供的所有食譜和建議僅供參考，使用者應自行判斷其適用性與安全性。我們不對因使用本網站內容而導致的任何直接或間接損失負責。我們保留隨時修改或終止服務的權利，恕不另行通知。禁止任何濫用本服務（如惡意爬取數據）的行為。",
                privacy_title: "隱私政策", privacy_content: "本隱私政策（最後更新於2025年8月16日）旨在說明我們如何收集、使用和保護您的信息。我們尊重您的隱私權，並致力於保護您的個人數據。我們通過 Google Analytics 收集匿名的使用數據（如頁面瀏覽量、設備類型），以改善服務質量，這些數據不包含個人身份信息。我們使用瀏覽器的 LocalStorage 技術來保存您的語言偏好和收藏的食譜，這些信息僅存儲在您的設備上，我們無法訪問。我們使用 Google AdSense 展示廣告，Google 可能會根據您的瀏覽行為使用 Cookie 來投放個性化廣告。您可以通過 Google 的廣告設置來管理您的廣告偏好。我們承諾不會將您的任何數據出售或分享給第三方。若您對本政策有任何疑問，請與我們聯繫。",
                tip_storage_title: "🥬 食材保存", tip_storage_content: "绿叶蔬菜用湿纸巾包裹后放入保鲜袋，可延长3-5天新鲜度", tip_seasoning_title: "🧂 调味技巧", tip_seasoning_content: "炒菜时盐要分两次放：炒制中期少许，起锅前调味",
                install_hint_text: "點擊右上角圖標，即可將應用程式下載到手機桌面！"
            },
            en: { 
                lang_switcher: "中文", main_title: "Fridge To Feast", subtitle: "Enter ingredients for ideas, or search for a recipe directly!", input_placeholder: "e.g., egg, tomato", start_button: "Start", thinking: "Thinking...", generating_recipe: "Generating Recipe...", generating_image: "Creating Image...", art_director: "Hiring Art Director...", how_to_cook: "How would you like to cook it?", ai_creative_style: "AI Creative Style", image_ref_note: "Image for reference only", calories_label: "Est. Calories", calories_note: "(approx.)", ingredients_label: "Ingredients", instructions_label: "Instructions", error_title: "Oh no, an error occurred!", error_title_busy: "AI Chef is Busy!", error_busy_text: "Server is currently busy. Please try again later. Consider saving recipes you like to your favorites!", error_input_required: "Please enter ingredients or a recipe name!", error_generic: "Could not process your request. Please try again later.", error_recipe_gen: "Failed to generate recipe. Please try again later.", error_timeout: "Request timed out, server is responding slowly.", error_network: "Network connection issue, please check your internet connection.", step_label: "Step", pref_vegetarian: "Vegetarian", pref_low_calorie: "Low-Calorie", pref_spicy: "Spicy", welcome_title: "Welcome to Fridge To Feast!", welcome_text: "Stop wondering what to cook with the ingredients in your fridge. We use AI to create delicious recipes, turning your leftovers into a feast!", how_to_use_title: "How to Use?", step1_text: "Enter the ingredients you have in the search bar above (e.g., egg, tomato, onion).", step2_text: "Select your dietary preferences (e.g., Vegetarian, Spicy).", step3_text: "Click 'Start' and let us work our magic!", popular_searches_title: "Popular Searches", my_favorites: "My Favorites", favorites_title: "My Favorite Recipes", no_favorites_text: "You haven't saved any recipes yet. When you find a recipe you like, click the star icon to save it!", favorite_reminder: "Like this recipe? Tap the star to save it for offline access!", retry_text: "Retry", retrying_text: "Retrying...", back_home: "Back to Home", warm_reminder_title: "💡 Friendly Reminder", warm_reminder_text: "This site uses real AI to generate recipes, not traditional search functions. We strive to create unique culinary inspiration for you, but our AI servers may occasionally be busy. Please be patient with us. We recommend saving your favorite recipes for easy access anytime!", daily_tips_title: "💡 Daily Cooking Tips", nutrition_tips_title: "🌟 Nutrition Pairing Knowledge", healthy_eating_title: "🍽️ Healthy Eating Guide",
                footer_about: "About Us", footer_faq: "FAQ", footer_terms: "Terms of Service", footer_privacy: "Privacy Policy", footer_copyright: "© 2025 Fridge To Feast. All Rights Reserved.", close_button: "Close",
                about_title: "About Us", about_content: "Fridge To Feast was born from a simple idea: make cooking more fun, easier, and reduce food waste. We use advanced AI technology to transform the scattered ingredients in your fridge into surprisingly delicious meals. Whether you're a novice cook or an experienced chef, we hope to inspire your culinary creativity and turn every meal into a feast.",
                faq_title: "Frequently Asked Questions", faq_q1_title: "Q1: Is this service free?", faq_q1_content: "Yes, our core recipe generation feature is completely free. We sustain our operations through advertisements on the site and appreciate your support.", faq_q2_title: "Q2: Are the AI-generated recipes reliable?", faq_q2_content: "Our AI is trained on a vast amount of recipe data to provide creative and practical cooking suggestions. However, AI is not perfect, and we recommend you adjust the recipes based on your own taste and experience.", faq_q3_title: "Q3: Why does recipe generation sometimes fail?", faq_q3_content: "Since the AI server requires significant computing resources, it may become congested or slow to respond during peak hours (like dinner time). If this happens, please try again later or use our popular search suggestions.", faq_q4_title: "Q4: Can I save recipes I like?", faq_q4_content: "Absolutely! There is a star icon in the top-right corner of each recipe card. Click it to save the recipe to 'My Favorites' for easy access anytime, even offline.", faq_q5_title: "Q5: Are the images real photos?", faq_q5_content: "The recipe images are generated by AI based on the recipe's content to provide visual inspiration. They are for reference only. The actual dish may vary depending on ingredients and cooking techniques.",
                terms_title: "Terms of Service", terms_content: "Welcome to Fridge To Feast! By using this website, you agree to the following terms: All recipes and suggestions provided are for reference only. Users should judge their suitability and safety. We are not responsible for any direct or indirect loss resulting from the use of this site's content. We reserve the right to modify or terminate the service at any time without notice. Any misuse of the service (e.g., malicious data scraping) is prohibited.",
                privacy_title: "Privacy Policy", privacy_content: "This Privacy Policy (last updated August 16, 2025) explains how we collect, use, and protect your information. We respect your privacy and are committed to protecting your personal data. We collect anonymous usage data (e.g., page views, device type) through Google Analytics to improve our service; this data does not contain personally identifiable information. We use your browser's LocalStorage to save your language preferences and favorite recipes, which are stored only on your device and are inaccessible to us. We use Google AdSense for advertising, and Google may use cookies to serve personalized ads based on your browsing behavior. You can manage your ad preferences through Google's Ad Settings. We will not sell or share your data with third parties. If you have any questions about this policy, please contact us.",
                tip_storage_title: "🥬 Ingredient Storage", tip_storage_content: "Wrap leafy greens in a damp paper towel and place them in a plastic bag to extend freshness by 3-5 days.", tip_seasoning_title: "🧂 Seasoning Tips", tip_seasoning_content: "When stir-frying, add salt in two stages: a little during the middle of cooking, and the rest to taste just before serving.",
                install_hint_text: "Tap the icon in the top right to add the app to your home screen!"
            }
        };
        let currentLanguage = localStorage.getItem('fridgeToFeastLang') || 'zh';
        
        // --- 基础缓存系统 ---
        class RecipeCache {
            constructor() {
                this.cache = new Map();
                this.maxSize = 50;
                this.preloadPopularRecipes();
            }

            set(key, value) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data: value,
                    timestamp: Date.now(),
                    hits: 0
                });
                
                try {
                    localStorage.setItem('recipeCache', JSON.stringify(Array.from(this.cache.entries())));
                } catch (e) {
                    console.log('缓存保存失败');
                }
            }

            get(key) {
                const item = this.cache.get(key);
                if (item) {
                    item.hits++;
                    item.lastAccessed = Date.now();
                    return item.data;
                }
                return null;
            }

            has(key) {
                return this.cache.has(key);
            }

            findSimilar(searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                for (const [key, value] of this.cache.entries()) {
                    if (key.toLowerCase().includes(searchLower) || searchLower.includes(key.toLowerCase())) {
                        value.hits++;
                        return { key, data: value.data, similarity: 'similar' };
                    }
                }
                return null;
            }

            async preloadPopularRecipes() {
                const popularIngredients = ['雞蛋', '鸡肉', '番茄', '马铃薯', '洋葱', '青菜', '猪肉', '鱼', '豆腐', '面条'];
                
                try {
                    const saved = localStorage.getItem('recipeCache');
                    if (saved) {
                        const entries = JSON.parse(saved);
                        this.cache = new Map(entries);
                        console.log('已恢复缓存:', this.cache.size, '个食谱');
                        return;
                    }
                } catch (e) {
                    console.log('缓存恢复失败');
                }

                console.log('开始预加载热门食谱...');
                for (const ingredient of popularIngredients.slice(0, 5)) {
                    if (!this.has(ingredient)) {
                        try {
                            const staticRecipe = this.generateStaticRecipe(ingredient);
                            this.set(ingredient, staticRecipe);
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (error) {
                            console.log(`预加载 ${ingredient} 失败:`, error);
                        }
                    }
                }
            }

            generateStaticRecipe(ingredient) {
                const recipes = {
                    '雞蛋': {
                        recipeName: '经典炒鸡蛋',
                        calories: 155,
                        ingredients: [
                            { name: '鸡蛋', quantity: '3个' },
                            { name: '盐', quantity: '少许' },
                            { name: '食用油', quantity: '1汤匙' },
                            { name: '葱花', quantity: '适量' }
                        ],
                        instructions: [
                            '将鸡蛋打散，加入少许盐调味',
                            '热锅下油，倒入蛋液',
                            '快速炒制至半熟状态',
                            '撒上葱花，继续炒至全熟即可'
                        ]
                    },
                    '鸡肉': {
                        recipeName: '嫩滑鸡肉丝',
                        calories: 240,
                        ingredients: [
                            { name: '鸡胸肉', quantity: '200克' },
                            { name: '生抽', quantity: '1汤匙' },
                            { name: '料酒', quantity: '1茶匙' },
                            { name: '淀粉', quantity: '1茶匙' }
                        ],
                        instructions: [
                            '鸡肉切丝，用生抽、料酒、淀粉腌制15分钟',
                            '热锅下油，下鸡肉丝炒至变色',
                            '加入调料炒匀',
                            '装盘即可享用'
                        ]
                    },
                    '番茄': {
                        recipeName: '番茄鸡蛋',
                        calories: 180,
                        ingredients: [
                            { name: '番茄', quantity: '2个' },
                            { name: '鸡蛋', quantity: '3个' },
                            { name: '糖', quantity: '1茶匙' },
                            { name: '盐', quantity: '适量' }
                        ],
                        instructions: [
                            '番茄去皮切块，鸡蛋打散',
                            '先炒鸡蛋盛起',
                            '炒番茄出汁，加糖和盐',
                            '倒入鸡蛋炒匀即可'
                        ]
                    }
                };

                return recipes[ingredient] || {
                    recipeName: `${ingredient}简易料理`,
                    calories: 200,
                    ingredients: [
                        { name: ingredient, quantity: '适量' },
                        { name: '盐', quantity: '少许' },
                        { name: '油', quantity: '适量' }
                    ],
                    instructions: [
                        `将${ingredient}清洗干净`,
                        '根据个人喜好进行调味',
                        '用适当的烹饪方法制作',
                        '装盘即可享用'
                    ]
                };
            }

            getStats() {
                const stats = {
                    totalItems: this.cache.size,
                    mostPopular: null,
                    oldestItem: null
                };

                let maxHits = 0;
                let oldestTime = Date.now();

                for (const [key, value] of this.cache.entries()) {
                    if (value.hits > maxHits) {
                        maxHits = value.hits;
                        stats.mostPopular = key;
                    }
                    if (value.timestamp < oldestTime) {
                        oldestTime = value.timestamp;
                        stats.oldestItem = key;
                    }
                }

                return stats;
            }
        }

        const recipeCache = new RecipeCache();

        const expertRecipes = {
            '擂茶': {
                zh: { recipeName: "正宗客家擂茶", calories: 450, ingredients: [ { name: "綠茶葉", quantity: "1湯匙" }, { name: "烤花生", quantity: "50克" }, { name: "烤芝麻", quantity: "2湯匙" }, { name: "薄荷葉", quantity: "1小把" }, { name: "九層塔 (金不換)", quantity: "1小把" }, { name: "長豆", quantity: "100克 (切粒)" }, { name: "菜脯 (甜)", quantity: "3湯匙 (切碎)" }, { name: "豆腐乾", quantity: "2塊 (切丁)" }, { name: "蝦米", quantity: "1湯匙 (可選)" }, { name: "樹仔菜", quantity: "1把" }, { name: "白飯", quantity: "2碗" } ], instructions: [ "擂茶醬：將綠茶葉、烤花生、烤芝麻、薄荷葉和九層塔放入擂缽中，用擂棍慢慢研磨成幼滑的糊狀。", "準備配料：分別將長豆、豆腐乾炒熟。菜脯和蝦米（如果使用）也稍微爆香備用。", "沖泡茶湯：將研磨好的擂茶醬取出，加入滾水攪拌均勻，依個人喜好用鹽調味。", "組合：在碗中盛入白飯，鋪上所有準備好的配料。", "享用：將溫熱的擂茶湯淋在飯上，攪拌均勻即可享用。" ] },
                en: { recipeName: "Authentic Hakka Lei Cha", calories: 450, ingredients: [ { name: "Green Tea Leaves", quantity: "1 tbsp" }, { name: "Roasted Peanuts", quantity: "50g" }, { name: "Toasted Sesame Seeds", quantity: "2 tbsp" }, { name: "Mint Leaves", quantity: "1 small handful" }, { name: "Basil Leaves", quantity: "1 small handful" }, { name: "Long Beans", quantity: "100g (diced)" }, { name: "Preserved Radish (sweet)", quantity: "3 tbsp (minced)" }, { name: "Firm Tofu", quantity: "2 blocks (diced)" }, { name: "Dried Shrimp", quantity: "1 tbsp (optional)" }, { name: "Mani Cai", quantity: "1 bunch" }, { name: "Cooked Rice", quantity: "2 bowls" } ], instructions: [ "Make the tea paste: In a traditional grooved bowl, grind the green tea leaves, roasted peanuts, sesame seeds, mint, and basil into a smooth paste.", "Prepare toppings: Sauté the long beans and diced tofu separately. Briefly stir-fry the preserved radish and dried shrimp (if using).", "Make the tea soup: Take the ground tea paste and whisk it with hot water until well combined. Season with salt to your liking.", "Assemble: Place cooked rice in a bowl and arrange all the prepared toppings over it.", "Serve: Pour the warm tea soup over the rice and toppings. Mix well and enjoy." ] }
            }
        };

        const mainInput = document.getElementById('main-input');
        const startBtn = document.getElementById('start-btn');
        const resultContainer = document.getElementById('result-container');
        const langSwitcherBtn = document.getElementById('lang-switcher');
        const myFavoritesBtn = document.getElementById('my-favorites-btn');
        const preferencesContainer = document.getElementById('preferences-container');
        const initialContentContainer = document.getElementById('initial-content-container');
        const templates = { 
            initialContent: document.getElementById('initial-content-template'), 
            favoritesView: document.getElementById('favorites-view-template'), 
            recipeCard: document.getElementById('recipe-card-template'), 
            error: document.getElementById('error-message-template'), 
        };

        function getFavorites() {
            try {
                return JSON.parse(localStorage.getItem('fridgeToFeastFavorites') || '[]');
            } catch (e) {
                console.error('讀取收藏失敗:', e);
                return [];
            }
        }

        function saveFavorites(favorites) {
            try {
                localStorage.setItem('fridgeToFeastFavorites', JSON.stringify(favorites));
                return true;
            } catch (e) {
                console.error('保存收藏失敗:', e);
                return false;
            }
        }

        function isFavorite(recipeName) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.recipeName === recipeName);
        }

        function toggleFavorite(recipeData, imageUrl) {
            let favorites = getFavorites();
            const recipeName = recipeData.recipeName;
            const existingIndex = favorites.findIndex(fav => fav.recipeName === recipeName);

            if (existingIndex > -1) {
                favorites.splice(existingIndex, 1);
                console.log('從收藏中移除:', recipeName);
            } else {
                favorites.push({ ...recipeData, imageUrl, savedAt: new Date().toISOString() });
                console.log('添加到收藏:', recipeName);
            }
            
            const saved = saveFavorites(favorites);
            if (!saved) {
                alert(currentLanguage === 'zh' ? '收藏功能暫時無法使用' : 'Favorites feature temporarily unavailable');
                return existingIndex === -1;
            }
            
            return existingIndex === -1;
        }

        function showFavorites() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = '';
            
            const favorites = getFavorites();
            const favoritesView = templates.favoritesView.content.cloneNode(true);
            resultContainer.appendChild(favoritesView);
            
            const noFavsText = resultContainer.querySelector('#no-favorites-text');

            if (favorites.length === 0) {
                noFavsText.style.display = 'block';
            } else {
                noFavsText.style.display = 'none';
                favorites.forEach(fav => {
                    displayRecipe(fav, fav.imageUrl, true);
                });
            }
            setLanguage(currentLanguage);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('fridgeToFeastLang', lang);
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang][key]) { 
                    el.innerHTML = translations[lang][key]; // Use innerHTML to support icons
                }
            });
            langSwitcherBtn.textContent = translations[lang].lang_switcher;
            mainInput.placeholder = translations[lang].input_placeholder;
        }

        function getSelectedPreferences() {
            const activeButtons = preferencesContainer.querySelectorAll('.preference-btn.active');
            return Array.from(activeButtons).map(btn => btn.dataset.preference);
        }

        function showLoadingStates() {
            const loadingStates = [
                translations[currentLanguage].thinking,
                translations[currentLanguage].generating_recipe,
                translations[currentLanguage].art_director,
                translations[currentLanguage].generating_image
            ];
            
            let currentStateIndex = 0;
            
            const updateLoadingText = () => {
                const span = startBtn.querySelector('span');
                if (span && startBtn.disabled) {
                    span.textContent = loadingStates[currentStateIndex % loadingStates.length];
                    currentStateIndex++;
                }
            };
            
            updateLoadingText();
            const interval = setInterval(() => {
                if (!startBtn.disabled) {
                    clearInterval(interval);
                    return;
                }
                updateLoadingText();
            }, 3000);
            
            return interval;
        }

        async function makeApiCallWithRetry(targetApi, payload, maxRetries = 3) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`API調用嘗試 ${attempt}/${maxRetries}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            targetApi: targetApi,
                            payload: payload
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API響應錯誤 ${response.status}:`, errorText);
                        
                        if (response.status === 503 || response.status === 429) {
                            throw new Error(`SERVER_BUSY_${response.status}`);
                        } else if (response.status >= 500) {
                            throw new Error(`SERVER_ERROR_${response.status}`);
                        } else {
                            throw new Error(`API_ERROR_${response.status}`);
                        }
                    }
                    
                    const result = await response.json();
                    console.log(`API調用成功，嘗試 ${attempt}`);
                    return result;
                    
                } catch (error) {
                    console.error(`API調用嘗試 ${attempt} 失敗:`, error);
                    lastError = error;
                    
                    if (error.name === 'AbortError') {
                        lastError = new Error('TIMEOUT_ERROR');
                    }
                    
                    if (attempt < maxRetries) {
                        const waitTime = Math.min(2000 * Math.pow(2, attempt - 1), 10000);
                        console.log(`等待 ${waitTime}ms 後重試...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
            }
            
            console.error('所有重試都失敗了');
            throw lastError;
        }

        function getErrorMessage(error) {
            const errorStr = error.toString();
            console.log('錯誤類型:', errorStr);
            
            if (errorStr.includes('SERVER_BUSY') || errorStr.includes('503')) {
                return {
                    title: translations[currentLanguage].error_title_busy,
                    message: translations[currentLanguage].error_busy_text,
                    isBusy: true
                };
            } else if (errorStr.includes('TIMEOUT')) {
                return {
                    title: translations[currentLanguage].error_title_busy,
                    message: translations[currentLanguage].error_timeout,
                    isBusy: true
                };
            } else if (errorStr.includes('NetworkError') || errorStr.includes('fetch')) {
                return {
                    title: translations[currentLanguage].error_title,
                    message: translations[currentLanguage].error_network,
                    isBusy: false
                };
            } else {
                return {
                    title: translations[currentLanguage].error_title,
                    message: error.message || translations[currentLanguage].error_generic,
                    isBusy: false
                };
            }
        }

        function displayError(message, isBusy = false, customTitle = null) { 
            resultContainer.innerHTML = ''; 
            const errorCard = templates.error.content.cloneNode(true); 
            
            const titleElement = errorCard.querySelector('.error-title');
            const textElement = errorCard.querySelector('.error-text');
            const retryBtn = errorCard.querySelector('.retry-btn');
            const retryText = errorCard.querySelector('.retry-text');
            const backBtn = errorCard.querySelector('.back-home-btn');
            
            if (customTitle) {
                titleElement.textContent = customTitle;
            } else if (isBusy) {
                titleElement.textContent = translations[currentLanguage].error_title_busy;
            } else {
                titleElement.textContent = translations[currentLanguage].error_title;
            }
            
            textElement.textContent = message;
            retryText.textContent = translations[currentLanguage].retry_text;
            
            retryBtn.addEventListener('click', () => {
                const lastInput = mainInput.value.trim();
                if (lastInput) {
                    retryText.innerHTML = `<div class="loading-spinner"></div>${translations[currentLanguage].retrying_text}`;
                    retryBtn.disabled = true;
                    setTimeout(() => {
                        handleInitialInput(lastInput);
                    }, 1000);
                }
            });
            
            backBtn.addEventListener('click', () => {
                showInitialContent();
            });
            
            resultContainer.appendChild(errorCard); 
        }

        function setLoading(isLoading, message) { 
            startBtn.disabled = isLoading; 
            const span = startBtn.querySelector('span');
            const icon = startBtn.querySelector('i');
            
            if (isLoading) {
                if (span) span.innerHTML = `<div class="loading-spinner"></div>${message}`;
                if (icon) icon.style.display = 'none';
                showLoadingStates();
            } else {
                if (span) span.textContent = translations[currentLanguage].start_button;
                if (icon) {
                    icon.style.display = 'inline';
                    icon.className = 'fas fa-search mr-2';
                }
            }
            
            if (isLoading && message === translations[currentLanguage].thinking) { 
                resultContainer.innerHTML = ''; 
            } 
        }

        async function checkCacheFirst(userInput) {
            const inputLower = userInput.toLowerCase();
            
            if (recipeCache.has(inputLower)) {
                return {
                    data: recipeCache.get(inputLower),
                    source: 'exact',
                    imageUrl: 'https://placehold.co/600x400/10B981/FFFFFF?text=Cached+Recipe'
                };
            }

            const similarResult = recipeCache.findSimilar(inputLower);
            if (similarResult) {
                return {
                    data: similarResult.data,
                    source: 'similar',
                    imageUrl: 'https://placehold.co/600x400/F59E0B/FFFFFF?text=Similar+Recipe'
                };
            }

            const popularIngredients = ['雞蛋', '鸡肉', '番茄', '马铃薯', '洋葱'];
            for (const ingredient of popularIngredients) {
                if (inputLower.includes(ingredient) && recipeCache.has(ingredient)) {
                    return {
                        data: recipeCache.get(ingredient),
                        source: 'ingredient_match',
                        imageUrl: 'https://placehold.co/600x400/8B5CF6/FFFFFF?text=Ingredient+Match'
                    };
                }
            }

            return null;
        }

        async function getFallbackFromCache(userInput) {
            const cache = recipeCache.cache;
            if (cache.size > 0) {
                let mostPopular = null;
                let maxHits = 0;
                
                for (const [key, value] of cache.entries()) {
                    if (value.hits > maxHits) {
                        maxHits = value.hits;
                        mostPopular = value.data;
                    }
                }

                if (mostPopular) {
                    return {
                        data: mostPopular,
                        source: 'fallback',
                        imageUrl: 'https://placehold.co/600x400/EF4444/FFFFFF?text=Popular+Recipe'
                    };
                }
            }
            return null;
        }

        async function handleInitialInput(userInput) {
            const trimmedInput = userInput.trim();
            if (!trimmedInput) {
                displayError(translations[currentLanguage].error_input_required);
                return;
            }

            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = ''; 

            const cacheResult = await checkCacheFirst(trimmedInput);
            if (cacheResult) {
                console.log('使用缓存结果:', cacheResult.source);
                displayRecipe(cacheResult.data, cacheResult.imageUrl || 'https://placehold.co/600x400/10B981/FFFFFF?text=Cached+Recipe', false);
                if (cacheResult.source === 'similar') {
                    showToast('为您推荐相似食谱 🔥');
                }
                return;
            }

            setLoading(true, translations[currentLanguage].thinking);

            try {
                const expertRecipeKey = Object.keys(expertRecipes).find(key => trimmedInput.includes(key));
                if (expertRecipeKey) {
                    const recipeData = expertRecipes[expertRecipeKey][currentLanguage];
                    await generateFinalRecipe(null, recipeData.recipeName, [], recipeData);
                    return;
                }

                const preferences = getSelectedPreferences();
                const inputType = await determineInputType(trimmedInput);

                if (inputType === 'recipe_name') {
                    await generateFinalRecipe(trimmedInput, trimmedInput, preferences);
                } else {
                    const styles = await getCookingStyles(trimmedInput, preferences);
                    displayCookingStyles(styles, trimmedInput, preferences);
                }
            } catch (error) {
                console.error("主要流程錯誤:", error);
                
                const fallbackResult = await getFallbackFromCache(trimmedInput);
                if (fallbackResult) {
                    displayRecipe(fallbackResult.data, fallbackResult.imageUrl || 'https://placehold.co/600x400/10B981/FFFFFF?text=Fallback+Recipe', false);
                    showToast('服务繁忙，为您推荐相关食谱 💫');
                } else {
                    const errorInfo = getErrorMessage(error);
                    displayError(errorInfo.message, errorInfo.isBusy, errorInfo.title);
                }
                setLoading(false);
            }
        }

        async function generateFinalRecipe(style, ingredients, preferences, preloadedRecipe = null) {
            try {
                let recipeData;
                if (preloadedRecipe) {
                    recipeData = preloadedRecipe;
                } else {
                    setLoading(true, translations[currentLanguage].generating_recipe);
                    recipeData = await generateRecipe(style, ingredients, preferences);
                    if (!recipeData) throw new Error(translations[currentLanguage].error_recipe_gen);
                    
                    const cacheKey = (style || ingredients).toLowerCase();
                    recipeCache.set(cacheKey, recipeData);
                }
                
                setLoading(true, translations[currentLanguage].art_director);
                const imagePromptIngredients = preloadedRecipe ? recipeData.recipeName : ingredients;
                const imageUrl = await generateImageWithArtDirector(recipeData, imagePromptIngredients);
                
                resultContainer.innerHTML = '';
                displayRecipe(recipeData, imageUrl, false);

            } catch (error) {
                console.error("生成食譜錯誤:", error);
                
                const fallbackResult = await getFallbackFromCache(ingredients);
                if (fallbackResult) {
                    displayRecipe(fallbackResult.data, fallbackResult.imageUrl, false);
                    showToast('AI繁忙中，为您推荐热门食谱 🌟');
                } else {
                    const errorInfo = getErrorMessage(error);
                    displayError(errorInfo.message, errorInfo.isBusy, errorInfo.title);
                }
            } finally {
                setLoading(false);
            }
        }

        async function determineInputType(userInput) { 
            const prompt = `Analyze the following text and determine if it's a 'list of ingredients' or a 'recipe name'. Text: "${userInput}". Respond with only "ingredients" or "recipe_name".`; 
            const payload = { contents: [{ parts: [{ text: prompt }] }] }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().replace(/"/g, ''); 
            if (text === 'ingredients' || text === 'recipe_name') return text; 
            return userInput.includes(',') || userInput.split(' ').length > 2 ? 'ingredients' : 'recipe_name'; 
        }
        
        async function getCookingStyles(ingredients, preferences) { 
            const langInstruction = currentLanguage === 'en' ? 'English' : 'Chinese';
            const preferenceText = preferences.length > 0 ? ` considering these preferences: ${preferences.join(', ')}` : '';
            const prompt = `In JSON array format, list the 4 most popular classic dish names for '${ingredients}' in the Malaysia/Singapore region${preferenceText}. Respond in ${langInstruction}. Example: ["Style A", "Style B"]`; 
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text; 
            let styles = []; 
            try { 
                styles = JSON.parse(text); 
                if (!Array.isArray(styles)) styles = []; 
            } catch { 
                styles = []; 
            } 
            styles.push(translations[currentLanguage].ai_creative_style); 
            return styles; 
        }

        async function generateRecipe(style, ingredients, preferences) { 
            const langInstruction = currentLanguage === 'en' ? 'Respond in English.' : '請用中文回答。';
            const preferenceText = preferences.length > 0 ? `\n3. CRITICAL: The recipe MUST strictly adhere to the following dietary preferences: ${preferences.join(', ')}.` : '';
            const baseRule = `\n\n**Rules:**\n1. Steps must be logical for a home cook.\n2. Quantities must be reasonable.${preferenceText}\nPlease respond STRICTLY in the following JSON format:\n- recipeName (string), description (string), calories (number), ingredients (array of {name, quantity}), instructions (array of strings).\n${langInstruction}`; 
            
            let prompt;
            if (style === translations[currentLanguage].ai_creative_style) { 
                prompt = `You are an experienced home cook. Design a delicious, logical recipe based on these ingredients: ${ingredients}. Create a suitable name for it.` + baseRule; 
            } else { 
                prompt = `You are a professional chef. Provide a detailed, authentic recipe for '${style}'. Main ingredients are '${ingredients}'. The recipe name must be '${style}'.` + baseRule; 
            } 
            
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }], 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            recipeName: { type: "STRING" }, 
                            description: { type: "STRING" }, 
                            calories: { type: "NUMBER" }, 
                            ingredients: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, quantity: { type: "STRING" } }, required: ["name", "quantity"] } }, 
                            instructions: { type: "ARRAY", items: { type: "STRING" } } 
                        }, 
                        required: ["recipeName", "description", "calories", "ingredients", "instructions"] 
                    } 
                } 
            }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text; 
            if (text) { 
                try { return JSON.parse(text); } catch(e) { console.error("解析食譜JSON失敗:", text, e); throw new Error("AI返回了無效的食譜格式。"); } 
            } 
            return null; 
        }
        
        async function generateImageWithArtDirector(recipeData, originalIngredients) {
            const artDirectorPrompt = await createVisualPrompt(recipeData.recipeName, originalIngredients);
            if (!artDirectorPrompt) {
                console.warn("Art Director失敗，使用基本圖片生成。");
                const fallbackPrompt = `Professional food photography of a dish named '${recipeData.recipeName}' with main ingredients '${originalIngredients}'.`;
                return await generateImage(fallbackPrompt);
            }
            setLoading(true, translations[currentLanguage].generating_image);
            return await generateImage(artDirectorPrompt);
        }

        async function createVisualPrompt(recipeName, ingredients) {
            const prompt = `Act as a professional food stylist. I will give you a dish name. Your task is to write a single, detailed paragraph in English for an AI image generator. This description should be a visually rich "prompt" that describes the dish's appearance, plating, texture, and common garnishes. Be specific about the cultural context (e.g., Japanese, Thai, Chinese).\n\nDish Name: "${recipeName}"\nMain Ingredients: "${ingredients}"\n\nProvide the detailed English visual description now.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const result = await makeApiCallWithRetry('gemini', payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
        }
        
        async function generateImage(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const result = await makeApiCallWithRetry('imagen', payload);

            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
            if (base64Data) {
                return `data:image/png;base64,${base64Data}`;
            }
            return `https://placehold.co/600x400/CCCCCC/FFFFFF?text=Image+Generation+Failed`;
        }

        function showInitialContent() {
            resultContainer.innerHTML = '';
            const content = templates.initialContent.content.cloneNode(true);
            initialContentContainer.innerHTML = '';
            initialContentContainer.appendChild(content);
            initialContentContainer.style.display = 'block';

            const popSearchContainer = initialContentContainer.querySelector('#popular-searches-container');
            if(popSearchContainer) {
                popSearchContainer.addEventListener('click', (event) => {
                    if (event.target.matches('.popular-search-btn')) {
                        const searchTerm = event.target.getAttribute('data-search');
                        mainInput.value = searchTerm;
                        handleInitialInput(searchTerm);
                    }
                });
            }
            setLanguage(currentLanguage);
        }

        function displayCookingStyles(styles, ingredients, preferences) {
            resultContainer.innerHTML = ''; 
            
            const styleCard = document.createElement('div');
            styleCard.className = 'bg-white p-6 rounded-xl shadow-md';
            styleCard.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="how_to_cook">${translations[currentLanguage].how_to_cook}</h2>
                <div id="style-buttons-container" class="space-y-4"></div>
            `;
            
            const container = styleCard.querySelector('#style-buttons-container'); 
            styles.forEach(style => { 
                const button = document.createElement('button'); 
                button.textContent = style; 
                button.className = 'style-btn w-full bg-white p-4 rounded-lg shadow border-2 border-gray-200 hover:border-green-500 hover:text-green-600 font-semibold transition-all'; 
                if (style === translations['zh'].ai_creative_style || style === translations['en'].ai_creative_style) { 
                    button.classList.add('bg-green-100', 'text-green-700'); 
                } 
                button.onclick = () => { 
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><div class="bg-gray-200 h-64 w-full rounded-lg animate-pulse"></div><div class="h-8 bg-gray-200 rounded w-3/4 mt-6 animate-pulse"></div></div>`; 
                    generateFinalRecipe(style, ingredients, preferences);
                }; 
                container.appendChild(button); 
            }); 
            resultContainer.appendChild(styleCard); 
            setLoading(false); 
        }

        function displayRecipe(data, imageUrl, isFavoriteView = false) { 
            const cardFragment = templates.recipeCard.content.cloneNode(true);
            const card = cardFragment.firstElementChild;
            
            card.querySelector('.recipe-image').src = imageUrl;
            card.querySelector('.recipe-image').alt = `Image of ${data.recipeName}`; 
            card.querySelector('.recipe-name').textContent = data.recipeName; 
            card.querySelector('.recipe-calories').textContent = data.calories; 
            
            const ingredientsList = card.querySelector('.recipe-ingredients'); 
            ingredientsList.innerHTML = ''; 
            data.ingredients.forEach(item => { 
                const li = document.createElement('li'); 
                li.textContent = `${item.name} - ${item.quantity}`; 
                ingredientsList.appendChild(li); 
            }); 
            
            const instructionsDiv = card.querySelector('.recipe-instructions'); 
            instructionsDiv.innerHTML = ''; 
            data.instructions.forEach((step, index) => { 
                const p = document.createElement('p'); 
                p.innerHTML = `<strong class="text-green-600">${translations[currentLanguage].step_label} ${index + 1}:</strong> ${step}`; 
                instructionsDiv.appendChild(p); 
            }); 

            const favBtn = card.querySelector('.favorite-btn');
            const favReminder = card.querySelector('.favorite-reminder');

            function updateFavButtonState() {
                const icon = favBtn.querySelector('i');
                if (isFavorite(data.recipeName)) {
                    favBtn.classList.add('saved');
                    icon.className = 'fas fa-star';
                    favBtn.title = currentLanguage === 'zh' ? "從我的最愛中移除" : "Remove from favorites";
                } else {
                    favBtn.classList.remove('saved');
                    icon.className = 'far fa-star';
                    favBtn.title = currentLanguage === 'zh' ? "加入我的最愛" : "Add to favorites";
                }
            }
            
            updateFavButtonState();

            favBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const wasAdded = toggleFavorite(data, imageUrl);
                updateFavButtonState();
                
                if (isFavoriteView && !wasAdded) {
                    card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-20px)';
                    setTimeout(() => { 
                        card.remove();
                        if (getFavorites().length === 0) {
                            const noFavsText = document.querySelector('#no-favorites-text');
                            if(noFavsText) noFavsText.style.display = 'block';
                        }
                    }, 300);
                }
                
                const feedbackMsg = wasAdded 
                    ? (currentLanguage === 'zh' ? '已加入收藏！' : 'Added to favorites!')
                    : (currentLanguage === 'zh' ? '已從收藏移除' : 'Removed from favorites');
                    
                showToast(feedbackMsg);
            };

            if (isFavoriteView) {
                favReminder.style.display = 'none';
            }
            
            setLanguage(currentLanguage);
            resultContainer.appendChild(card); 
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-x-full';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function showCookingTips() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">👨‍🍳 烹饪技巧大全</h2>
                        <button onclick="showInitialContent()" class="text-green-500 hover:text-green-600 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>返回首页
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <section class="border-l-4 border-green-500 pl-4">
                            <h3 class="text-xl font-semibold mb-3">🔥 火候控制技巧</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li><strong>大火爆炒：</strong>适合绿叶蔬菜，保持脆嫩口感和鲜艳颜色</li>
                                <li><strong>中火煎炸：</strong>鱼类、肉类外焦内嫩的关键</li>
                                <li><strong>小火慢炖：</strong>汤品、炖菜入味的秘诀</li>
                                <li><strong>余温利用：</strong>关火后用余温焖煮，节能又美味</li>
                            </ul>
                        </section>

                        <section class="border-l-4 border-blue-500 pl-4">
                            <h3 class="text-xl font-semibold mb-3">🧂 调味黄金比例</h3>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <ul class="space-y-2 text-gray-700">
                                    <li><strong>糖醋比例：</strong>糖1：醋2，酸甜适中</li>
                                    <li><strong>腌制肉类：</strong>盐1%，糖0.5%，料酒10%</li>
                                    <li><strong>炒菜用盐：</strong>500g菜品用盐3-5g</li>
                                    <li><strong>汤品调味：</strong>先淡后浓，逐步调整</li>
                                </ul>
                            </div>
                        </section>
                    </div>
                </div>
            `;
        }

        function showNutritionGuide() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">🥑 营养搭配指南</h2>
                        <button onclick="showInitialContent()" class="text-green-500 hover:text-green-600 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>返回首页
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <section class="border-l-4 border-green-500 pl-4">
                            <h3 class="text-xl font-semibold mb-3">🌈 彩虹饮食法</h3>
                            <p class="text-gray-600">每天摄入不同颜色的蔬果，确保营养素的全面性</p>
                        </section>
                    </div>
                </div>
            `;
        }

        function showStorageGuide() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">🧊 食材保存秘籍</h2>
                        <button onclick="showInitialContent()" class="text-green-500 hover:text-green-600 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>返回首页
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <section class="border-l-4 border-green-500 pl-4">
                            <h3 class="text-xl font-semibold mb-3">🥬 蔬菜保存技巧</h3>
                            <p class="text-gray-600">科学的保存方法，延长食材新鲜度</p>
                        </section>
                    </div>
                </div>
            `;
        }

        function showSeasonalRecipes() {
            initialContentContainer.style.display = 'none';
            resultContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">🌸 时令食谱推荐</h2>
                        <button onclick="showInitialContent()" class="text-green-500 hover:text-green-600 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>返回首页
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <section class="border-l-4 border-pink-500 pl-4">
                            <h3 class="text-xl font-semibold mb-3">🌸 春季时令</h3>
                            <p class="text-gray-600">根据季节推荐最佳食材和菜品</p>
                        </section>
                    </div>
                </div>
            `;
        }

        function searchSeasonal(term) {
            mainInput.value = term;
            handleInitialInput(term);
        }

        // --- Modal 處理 ---
        function setupModals() {
            const modalLinks = {
                'about-link': 'modal-about',
                'faq-link': 'modal-faq',
                'terms-link': 'modal-terms',
                'privacy-link': 'modal-privacy'
            };

            Object.entries(modalLinks).forEach(([linkId, modalId]) => {
                const link = document.getElementById(linkId);
                const modal = document.getElementById(modalId);
                if (link && modal) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        modal.classList.add('active');
                    });
                }
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal-overlay').classList.remove('active');
                });
            });
        }
        
        // --- PWA 安装提示處理 ---
        function setupPwaInstall() {
            let deferredPrompt;
            const installHint = document.getElementById('install-hint');

            window.addEventListener('beforeinstallprompt', (e) => {
                // 防止 Chrome 67 及更早版本自动显示安装提示
                e.preventDefault();
                // 存储事件以便稍后触发
                deferredPrompt = e;
                // 显示我们自定义的提示
                if (installHint) {
                    console.log("PWA is installable, showing hint.");
                    installHint.classList.remove('hidden');
                }
            });
            
            window.addEventListener('appinstalled', () => {
                // 隐藏提示因为应用已经被安装
                if (installHint) {
                    installHint.classList.add('hidden');
                }
                console.log('PWA was installed');
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            showInitialContent();
            setupModals();
            setupPwaInstall();
            
            recipeCache.preloadPopularRecipes();
            
            startBtn.addEventListener('click', () => handleInitialInput(mainInput.value));
            mainInput.addEventListener('keyup', (event) => { 
                if (event.key === 'Enter') handleInitialInput(mainInput.value); 
            });
            langSwitcherBtn.addEventListener('click', () => { 
                const newLang = currentLanguage === 'zh' ? 'en' : 'zh'; 
                setLanguage(newLang); 
            });
            myFavoritesBtn.addEventListener('click', showFavorites);
            
            preferencesContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('preference-btn')) {
                    event.target.classList.toggle('active');
                }
            });

            setTimeout(() => {
                const stats = recipeCache.getStats();
                console.log('缓存统计:', stats);
            }, 2000);
        });

    </script>
</body>
</html>
