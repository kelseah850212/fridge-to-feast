<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge To Feast (v2.1 Streaming)</title>
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJGcmlkZ2UgVG8gRmVhc3QiLA0KICAic2hvcnRfbmFtZSI6ICJGcmlkZ2VGZWFzdCIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjE5MngxOTIiDQogICAgfSwNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiDQogICAgfQ0KICBdLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgInRoZW1lX2NvbG9yIjogIiMxMEI5ODEiLA0KICAiYmFja2dyb3VuZF_jb2xvciI6ICIjRjlGQUZCIg0KfQ==">
    <meta name="theme-color" content="#10B981">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap');
        body { font-family: 'Poppins', 'Noto Sans TC', sans-serif; }
        .style-btn { transition: all 0.2s ease-in-out; }
        .style-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .preference-btn { transition: all 0.2s ease-in-out; }
        .preference-btn.active {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }
        /* 游標閃爍效果 */
        .blinking-cursor {
            font-weight: 500;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent; }
            50% { color: #333; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl p-4 relative pb-24">
        <button id="lang-switcher" class="absolute top-4 right-4 text-sm font-semibold text-gray-600 hover:text-green-500 py-2 px-3 bg-white rounded-lg shadow-sm border">English</button>
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-gray-800" data-translate="main_title">Fridge To Feast</h1>
            <p class="text-gray-500 mt-2" data-translate="subtitle">輸入食材找靈感，或直接搜尋菜名！</p>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-green-500 transition-colors">
                <i class="fas fa-utensils text-gray-400 mx-3"></i>
                <input type="text" id="main-input" class="w-full p-3 outline-none">
                <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-r-lg transition-colors">
                    <i class="fas fa-search mr-2"></i><span data-translate="start_button">開始</span>
                </button>
            </div>
            <div id="preferences-container" class="mt-4 flex flex-wrap justify-center gap-3">
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="vegetarian" data-translate="pref_vegetarian">素食</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="low-calorie" data-translate="pref_low_calorie">低熱量</button>
                <button class="preference-btn py-2 px-4 bg-white border-2 border-gray-200 rounded-full text-sm font-semibold text-gray-600" data-preference="spicy" data-translate="pref_spicy">要辣</button>
            </div>
        </div>
        <div id="result-container" class="mt-8"></div>
    </div>

    <!-- Templates -->
    <template id="style-selection-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-bold text-gray-700 mb-4 text-center" data-translate="how_to_cook">你想怎麼煮？</h3>
            <div id="style-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </template>
    <template id="recipe-card-template">
        <div class="bg-white p-6 rounded-xl shadow-lg relative">
            <div class="relative"><img id="recipe-image" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-6 shadow-md"><div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded" data-translate="image_ref_note">图片只供参考</div></div>
            <h2 id="recipe-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p class="text-gray-600 mb-4"><i class="fas fa-fire-alt mr-2 text-red-500"></i><span data-translate="calories_label">預估卡路里</span>: <span id="recipe-calories"></span> <span class="text-xs text-gray-400" data-translate="calories_note">(估算值)</span></p>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="ingredients_label">所需食材</h3><ul id="recipe-ingredients" class="list-disc list-inside space-y-2 text-gray-600"></ul></div>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4" data-translate="instructions_label">做法</h3><div id="recipe-instructions" class="space-y-3 text-gray-600 leading-relaxed"></div></div>
        </div>
    </template>
    <template id="error-message-template">
         <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold" data-translate="error_title">噢不，出錯了！</p><p id="error-text"></p></div>
    </template>

    <script>
        // --- STABILITY: Global Error Handler ---
        window.onerror = function(message, source, lineno, colno, error) { /* ... same as before ... */ };

        // --- I18N ---
        const translations = { /* ... same as before ... */ };
        let currentLanguage = localStorage.getItem('fridgeToFeastLang') || 'zh';

        // --- DOM ELEMENTS ---
        const mainInput = document.getElementById('main-input');
        const startBtn = document.getElementById('start-btn');
        const resultContainer = document.getElementById('result-container');
        const langSwitcherBtn = document.getElementById('lang-switcher');
        const preferencesContainer = document.getElementById('preferences-container');
        const templates = { styleSelection: document.getElementById('style-selection-template'), recipeCard: document.getElementById('recipe-card-template'), error: document.getElementById('error-message-template'), };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            startBtn.addEventListener('click', () => handleInitialInput(mainInput.value));
            mainInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleInitialInput(mainInput.value); });
            langSwitcherBtn.addEventListener('click', () => { const newLang = currentLanguage === 'zh' ? 'en' : 'zh'; setLanguage(newLang); });
            preferencesContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('preference-btn')) {
                    event.target.classList.toggle('active');
                }
            });
        });

        // --- LANGUAGE FUNCTIONS ---
        function setLanguage(lang) { /* ... same as before ... */ }

        // --- HELPER FUNCTIONS ---
        function getSelectedPreferences() { /* ... same as before ... */ }

        // --- MAIN LOGIC ---
        async function handleInitialInput(userInput) {
            const trimmedInput = userInput.trim();
            if (!trimmedInput) {
                displayError(translations[currentLanguage].error_input_required);
                return;
            }
            setLoading(true, translations[currentLanguage].thinking);
            const preferences = getSelectedPreferences();
            try {
                const inputType = await determineInputType(trimmedInput);
                if (inputType === 'recipe_name') {
                    await generateFinalRecipe(trimmedInput, trimmedInput, preferences);
                } else {
                    const styles = await getCookingStyles(trimmedInput, preferences);
                    displayCookingStyles(styles, trimmedInput, preferences);
                }
            } catch (error) {
                console.error("Critical Error in Main Flow:", error);
                displayError(error.message || translations[currentLanguage].error_generic);
                setLoading(false);
            }
        }

        async function generateFinalRecipe(style, ingredients, preferences) {
            try {
                setLoading(true, translations[currentLanguage].generating_recipe);
                
                // --- v2.1 串流核心修改 ---
                // 1. 先顯示一個空的卡片結構
                const emptyCard = displayEmptyRecipeCard();
                
                // 2. 開始串流並填充內容
                const recipeData = await streamAndParseRecipe(style, ingredients, preferences, emptyCard);
                if (!recipeData) throw new Error(translations[currentLanguage].error_recipe_gen);

                // 3. 食譜完成後，再生成圖片
                setLoading(true, translations[currentLanguage].art_director);
                const imageUrl = await generateImageWithArtDirector(recipeData, ingredients);
                emptyCard.querySelector('#recipe-image').src = imageUrl;

            } catch (error) {
                console.error("Error in generateFinalRecipe:", error);
                displayError(error.message);
            } finally {
                setLoading(false);
            }
        }

        // --- UI DISPLAY ---
        function setLoading(isLoading, message) { /* ... same as before ... */ }
        function displayError(message) { /* ... same as before ... */ }
        function displayCookingStyles(styles, ingredients, preferences) { /* ... same as before ... */ }
        
        // v2.1 新增: 顯示一個空的卡片，為串流做準備
        function displayEmptyRecipeCard() {
            resultContainer.innerHTML = '';
            const card = templates.recipeCard.content.cloneNode(true);
            // 預先填充標題，讓使用者知道正在載入
            card.querySelector('[data-translate="ingredients_label"]').textContent = translations[currentLanguage].ingredients_label;
            card.querySelector('[data-translate="instructions_label"]').textContent = translations[currentLanguage].instructions_label;
            card.querySelector('#recipe-image').src = 'https://placehold.co/600x400/f0f0f0/f0f0f0'; // 灰色佔位符
            resultContainer.appendChild(card);
            return resultContainer.querySelector('.bg-white'); // 返回卡片的DOM元素
        }

        // v2.1 修改: 這個函數現在只負責填充已有的卡片
        function displayRecipe(cardElement, data, imageUrl) {
            cardElement.querySelector('#recipe-image').src = imageUrl;
            cardElement.querySelector('#recipe-name').textContent = data.recipeName;
            cardElement.querySelector('#recipe-calories').textContent = data.calories;
            const ingredientsList = cardElement.querySelector('#recipe-ingredients');
            ingredientsList.innerHTML = '';
            data.ingredients.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} - ${item.quantity}`;
                ingredientsList.appendChild(li);
            });
            const instructionsDiv = cardElement.querySelector('#recipe-instructions');
            instructionsDiv.innerHTML = '';
            data.instructions.forEach((step, index) => {
                const p = document.createElement('p');
                p.innerHTML = `<strong class="text-green-600">${translations[currentLanguage].step_label} ${index + 1}:</strong> ${step}`;
                instructionsDiv.appendChild(p);
            });
        }

        // --- API HELPERS (v2.1 Streaming) ---
        async function makeApiCallWithRetry(targetApi, payload, maxRetries = 3) { /* ... same as before ... */ }
        async function determineInputType(userInput) { /* ... same as before ... */ }
        async function getCookingStyles(ingredients, preferences) { /* ... same as before ... */ }

        // v2.1 修改: generateRecipe 現在只負責發送請求，不處理串流
        function generateRecipePayload(style, ingredients, preferences) {
            const langInstruction = currentLanguage === 'en' ? 'Respond in English.' : '請用中文回答。';
            const preferenceText = preferences.length > 0 ? `\n3. CRITICAL: The recipe MUST strictly adhere to the following dietary preferences: ${preferences.join(', ')}.` : '';
            const baseRule = `\n\n**Rules:**\n1. Steps must be logical for a home cook.\n2. Quantities must be reasonable.${preferenceText}\nPlease respond STRICTLY in the following JSON format:\n- recipeName (string), description (string), calories (number), ingredients (array of {name, quantity}), instructions (array of strings).\n${langInstruction}`;
            let prompt;
            if (style === translations[currentLanguage].ai_creative_style) {
                prompt = `You are an experienced home cook. Design a delicious, logical recipe based on these ingredients: ${ingredients}. Create a suitable name for it.` + baseRule;
            } else {
                prompt = `You are a professional chef. Provide a detailed, authentic recipe for '${style}'. Main ingredients are '${ingredients}'. The recipe name must be '${style}'.` + baseRule;
            }
            return { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
        }

        // v2.1 新增: 處理串流並解析JSON的核心函數
        async function streamAndParseRecipe(style, ingredients, preferences, cardElement) {
            const payload = generateRecipePayload(style, ingredients, preferences);
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetApi: 'geminiStream', payload: payload })
            });

            if (!response.ok) {
                throw new Error(`API Stream Error ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            let buffer = '';

            // 獲取要填充的元素
            const nameEl = cardElement.querySelector('#recipe-name');
            const caloriesEl = cardElement.querySelector('#recipe-calories');
            const ingredientsList = cardElement.querySelector('#recipe-ingredients');
            const instructionsDiv = cardElement.querySelector('#recipe-instructions');
            
            nameEl.innerHTML = '<span class="blinking-cursor">|</span>'; // 開始時顯示游標

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // Google串流API有時會把JSON分塊，我們要把它們拼回來
                // 簡單起見，我們在這裡累積所有文字
                fullText += decoder.decode(value, { stream: true });
                
                // 移除Google串流有時會加入的前後綴
                let cleanJsonText = fullText.replace(/^data: /, '').trim();
                
                // 即時更新UI的簡易方法：直接顯示收到的文字
                // 為了更好的體驗，我們解析JSON並逐一顯示
                try {
                    // 嘗試解析累積的JSON文字
                    const parsedData = JSON.parse(cleanJsonText);
                    
                    // 如果成功解析，就更新整個卡片
                    nameEl.textContent = parsedData.recipeName || '';
                    caloriesEl.textContent = parsedData.calories || '';
                    
                    ingredientsList.innerHTML = '';
                    (parsedData.ingredients || []).forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item.name} - ${item.quantity}`;
                        ingredientsList.appendChild(li);
                    });

                    instructionsDiv.innerHTML = '';
                    (parsedData.instructions || []).forEach((step, index) => {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong class="text-green-600">${translations[currentLanguage].step_label} ${index + 1}:</strong> ${step}`;
                        instructionsDiv.appendChild(p);
                    });

                } catch (e) {
                    // JSON不完整，繼續接收
                    // 為了讓使用者看到進度，我們可以在標題處顯示打字效果
                    let partialName = cleanJsonText.match(/"recipeName":\s*"([^"]*)/);
                    if (partialName && partialName[1]) {
                        nameEl.innerHTML = partialName[1] + '<span class="blinking-cursor">|</span>';
                    }
                }
            }
            
            // 串流結束後，確保最終內容是正確的
            try {
                const finalData = JSON.parse(fullText);
                displayRecipe(cardElement, finalData, cardElement.querySelector('#recipe-image').src);
                return finalData;
            } catch (e) {
                console.error("Failed to parse final JSON from stream:", e);
                throw new Error("AI returned invalid recipe format.");
            }
        }

        // --- Plan A - Image Generation Functions ---
        async function generateImageWithArtDirector(recipeData, originalIngredients) { /* ... same as before ... */ }
        async function createVisualPrompt(recipeName, ingredients) { /* ... same as before ... */ }
        async function generateImage(prompt) { /* ... same as before ... */ }
    </script>
</body>
</html>
```