<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge To Feast (Stable 1.0)</title>
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJGcmlkZ2UgVG8gRmVhc3QiLA0KICAic2hvcnRfbmFtZSI6ICJGcmlkZ2VGZWFzdCIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjE5MngxOTIiDQogICAgfSwNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDBBMDgwL0ZGRkZGRj90ZXh0PUYyRiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiDQogICAgfQ0KICBdLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgInRoZW1lX2NvbG9yIjogIiMxMEI5ODEiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRjlGQUZCIg0KfQ==">
    <meta name="theme-color" content="#10B981">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap');
        body { font-family: 'Poppins', 'Noto Sans TC', sans-serif; }
        .style-btn { transition: all 0.2s ease-in-out; }
        .style-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl p-4 relative pb-24">
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-gray-800">Fridge To Feast</h1>
            <p class="text-gray-500 mt-2">輸入食材找靈感，或直接搜尋菜名！</p>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex items-center border-2 border-gray-200 rounded-lg focus-within:border-green-500 transition-colors">
                <i class="fas fa-utensils text-gray-400 mx-3"></i>
                <input type="text" id="main-input" class="w-full p-3 outline-none" placeholder="例如: 雞蛋, 番茄">
                <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-r-lg transition-colors">
                    <i class="fas fa-search mr-2"></i><span>開始</span>
                </button>
            </div>
        </div>
        <div id="result-container" class="mt-8"></div>
    </div>

    <!-- Templates -->
    <template id="style-selection-template">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">你想怎麼煮？</h3>
            <div id="style-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </template>
    <template id="recipe-card-template">
        <div class="bg-white p-6 rounded-xl shadow-lg relative">
            <div class="relative"><img id="recipe-image" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-6 shadow-md"><div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">图片只供参考</div></div>
            <h2 id="recipe-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
            <p class="text-gray-600 mb-4"><i class="fas fa-fire-alt mr-2 text-red-500"></i>預估卡路里: <span id="recipe-calories"></span> <span class="text-xs text-gray-400">(估算值)</span></p>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4">所需食材</h3><ul id="recipe-ingredients" class="list-disc list-inside space-y-2 text-gray-600"></ul></div>
            <div class="mt-6"><h3 class="text-xl font-semibold text-gray-700 border-b-2 border-green-500 pb-2 mb-4">做法</h3><div id="recipe-instructions" class="space-y-3 text-gray-600 leading-relaxed"></div></div>
        </div>
    </template>
    <template id="error-message-template">
         <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">噢不，出錯了！</p><p id="error-text"></p></div>
    </template>

    <script>
        // --- 全局錯誤處理 ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("A global error was caught:", message, error);
            try {
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">噢不，發生了未知的錯誤！</p><p>請稍後再試或重新整理頁面。</p></div>`;
                }
            } catch (e) {
                console.error("Could not display global error message:", e);
            }
            return true;
        };

        // --- DOM 元素 ---
        const mainInput = document.getElementById('main-input');
        const startBtn = document.getElementById('start-btn');
        const resultContainer = document.getElementById('result-container');
        const templates = {
            styleSelection: document.getElementById('style-selection-template'),
            recipeCard: document.getElementById('recipe-card-template'),
            error: document.getElementById('error-message-template'),
        };

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            startBtn.addEventListener('click', () => handleInitialInput(mainInput.value));
            mainInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleInitialInput(mainInput.value);
            });
        });

        // --- 主要邏輯 ---
        async function handleInitialInput(userInput) {
            const trimmedInput = userInput.trim();
            if (!trimmedInput) {
                displayError("請輸入食材或菜名！");
                return;
            }
            setLoading(true, "思考中...");
            
            try {
                const inputType = await determineInputType(trimmedInput);
                if (inputType === 'recipe_name') {
                    await generateFinalRecipe(trimmedInput, trimmedInput);
                } else {
                    const styles = await getCookingStyles(trimmedInput);
                    displayCookingStyles(styles, trimmedInput);
                }
            } catch (error) {
                console.error("Critical Error in Main Flow:", error);
                displayError(error.message || "無法處理您的請求，請稍後再試。");
                setLoading(false);
            }
        }

        async function generateFinalRecipe(style, ingredients) {
            try {
                setLoading(true, "生成食譜中...");
                const recipeData = await generateRecipe(style, ingredients);
                if (!recipeData) throw new Error("生成食譜失敗，請稍後再試。");

                displayRecipe(recipeData, 'https://placehold.co/600x400/f0f0f0/f0f0f0?text=+');

                setLoading(true, "聘請造型師...");
                const imageUrl = await generateImageWithArtDirector(recipeData, ingredients);
                
                const imageEl = resultContainer.querySelector('#recipe-image');
                if (imageEl) imageEl.src = imageUrl;

            } catch (error) {
                console.error("Error in generateFinalRecipe:", error);
                displayError(error.message);
            } finally {
                setLoading(false);
            }
        }

        // --- 介面顯示 ---
        function setLoading(isLoading, message) {
            startBtn.disabled = isLoading;
            startBtn.querySelector('span').textContent = isLoading ? message : "開始";
            if (isLoading && message === "思考中...") {
                resultContainer.innerHTML = '';
            }
        }

        function displayError(message) {
            resultContainer.innerHTML = '';
            const errorCard = templates.error.content.cloneNode(true);
            errorCard.getElementById('error-text').textContent = message;
            resultContainer.appendChild(errorCard);
        }

        function displayCookingStyles(styles, ingredients) {
            resultContainer.innerHTML = '';
            const styleCard = templates.styleSelection.content.cloneNode(true);
            const container = styleCard.getElementById('style-buttons-container');
            styles.forEach(style => {
                const button = document.createElement('button');
                button.textContent = style;
                button.className = 'style-btn w-full bg-white p-4 rounded-lg shadow border-2 border-gray-200 hover:border-green-500 hover:text-green-600 font-semibold';
                if (style === "AI創意煮法") {
                    button.classList.add('bg-green-100', 'text-green-700');
                }
                button.onclick = () => {
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><div class="bg-gray-200 h-64 w-full rounded-lg animate-pulse"></div><div class="h-8 bg-gray-200 rounded w-3/4 mt-6 animate-pulse"></div></div>`;
                    generateFinalRecipe(style, ingredients);
                };
                container.appendChild(button);
            });
            resultContainer.appendChild(styleCard);
            setLoading(false);
        }
        
        function displayRecipe(data, imageUrl) {
            resultContainer.innerHTML = '';
            const cardTemplate = templates.recipeCard.content.cloneNode(true);
            const cardElement = cardTemplate.querySelector('.bg-white');
            
            cardElement.querySelector('#recipe-image').src = imageUrl;
            cardElement.querySelector('#recipe-name').textContent = data.recipeName || '';
            cardElement.querySelector('#recipe-calories').textContent = data.calories || '';
            
            const ingredientsList = cardElement.querySelector('#recipe-ingredients');
            ingredientsList.innerHTML = '';
            if (data.ingredients && Array.isArray(data.ingredients)) {
                data.ingredients.forEach(item => {
                    const li = document.createElement('li');
                    if (item.name && item.quantity) {
                        li.textContent = `${item.name} - ${item.quantity}`;
                        ingredientsList.appendChild(li);
                    }
                });
            }

            const instructionsDiv = cardElement.querySelector('#recipe-instructions');
            instructionsDiv.innerHTML = '';
            if (data.instructions && Array.isArray(data.instructions)) {
                data.instructions.forEach((step, index) => {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong class="text-green-600">步驟 ${index + 1}:</strong> ${step}`;
                    instructionsDiv.appendChild(p);
                });
            }
            
            resultContainer.appendChild(cardTemplate);
        }

        // --- API 呼叫 (後端代理) ---
        async function makeApiCallWithRetry(targetApi, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ targetApi, payload })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("API Proxy Error Response:", errorText);
                        throw new Error(`API Proxy Error ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }
        
        // --- AI 提示 (Prompts) ---
        async function determineInputType(userInput) { 
            const prompt = `Analyze the following text and determine if it's a 'list of ingredients' or a 'recipe name'. Text: "${userInput}". Respond with only "ingredients" or "recipe_name".`; 
            const payload = { contents: [{ parts: [{ text: prompt }] }] }; 
            const result = await makeApiCallWithRetry('gemini', payload); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().replace(/"/g, ''); 
            if (text === 'ingredients' || text === 'recipe_name') return text; 
            return userInput.includes(',') || userInput.split(' ').length > 2 ? 'ingredients' : 'recipe_name'; 
        }
        
        async function getCookingStyles(ingredients) {
            const prompt = `In JSON array format, list the 4 most popular classic dish names for '${ingredients}' in the Malaysia/Singapore region. Respond in Chinese. Example: ["Style A", "Style B"]`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const result = await makeApiCallWithRetry('gemini', payload);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            let styles = [];
            try {
                styles = JSON.parse(text);
                if (!Array.isArray(styles)) styles = [];
            } catch {
                styles = [];
            }
            styles.push("AI創意煮法");
            return styles;
        }

        async function generateRecipe(style, ingredients) {
            const baseRule = `\n\n**Rules:**\n1. Steps must be logical for a home cook.\n2. Quantities must be reasonable.\nPlease respond STRICTLY in the following JSON format:\n- recipeName (string), description (string), calories (number), ingredients (array of {name, quantity}), instructions (array of strings).\n請用中文回答。`;
            let prompt;
            if (style === "AI創意煮法") {
                prompt = `You are an experienced home cook. Design a delicious, logical recipe based on these ingredients: ${ingredients}. Create a suitable name for it.` + baseRule;
            } else {
                prompt = `You are a professional chef. Provide a detailed, authentic recipe for '${style}'. Main ingredients are '${ingredients}'. The recipe name must be '${style}'.` + baseRule;
            }
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const result = await makeApiCallWithRetry('gemini', payload);
            return result; // 直接返回完整的JSON物件
        }

        async function generateImageWithArtDirector(recipeData, originalIngredients) {
            const artDirectorPrompt = await createVisualPrompt(recipeData.recipeName, originalIngredients);
            if (!artDirectorPrompt) {
                console.warn("Art Director failed. Falling back to basic image generation.");
                const fallbackPrompt = `Professional food photography of a dish named '${recipeData.recipeName}' with main ingredients '${originalIngredients}'.`;
                return await generateImage(fallbackPrompt);
            }
            setLoading(true, "繪製圖片中...");
            return await generateImage(artDirectorPrompt);
        }

        async function createVisualPrompt(recipeName, ingredients) {
            const prompt = `Act as a professional food stylist. I will give you a dish name. Your task is to write a single, detailed paragraph in English for an AI image generator. This description should be a visually rich "prompt" that describes the dish's appearance, plating, texture, and common garnishes. Be specific about the cultural context (e.g., Japanese, Thai, Chinese).\n\nDish Name: "${recipeName}"\nMain Ingredients: "${ingredients}"\n\nProvide the detailed English visual description now.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const result = await makeApiCallWithRetry('gemini', payload);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
        }
        
        async function generateImage(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            const result = await makeApiCallWithRetry('imagen', payload);
            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
            if (base64Data) {
                return `data:image/png;base64,${base64Data}`;
            }
            return `https://placehold.co/600x400/CCCCCC/FFFFFF?text=Image+Generation+Failed`;
        }

    </script>
</body>
</html>
